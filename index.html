<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé£ Â§ßÊºÅ„Éï„Ç£„ÉÉ„Ç∑„É≥„Ç∞</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Permanent+Marker&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--ocean-deep:#0a1628;--gold:#ffd700;--gold-dark:#b8960f;--danger:#ff4444;--success:#44ff88}
body{font-family:'Noto Sans JP',sans-serif;background:var(--ocean-deep);color:#fff;overflow:hidden;height:100vh;width:100vw;user-select:none}
#game-container{position:relative;width:100%;height:100%;overflow:hidden}
#sky{position:absolute;top:0;left:0;right:0;height:30%;background:linear-gradient(180deg,#0b1a3a 0%,#1a3a6a 40%,#2a5a9a 70%,#ff8844 90%,#ffaa44 100%)}
#sun{position:absolute;bottom:5%;left:20%;width:60px;height:60px;background:radial-gradient(circle,#ffee88,#ffaa22);border-radius:50%;box-shadow:0 0 40px #ffaa44,0 0 80px #ff884488;animation:sunPulse 4s ease-in-out infinite}
@keyframes sunPulse{0%,100%{box-shadow:0 0 40px #ffaa44,0 0 80px #ff884488}50%{box-shadow:0 0 60px #ffcc44,0 0 100px #ffaa4488}}
#water{position:absolute;top:30%;left:0;right:0;bottom:0;background:linear-gradient(180deg,#1a4a7a 0%,#0d2847 30%,#0a1628 100%)}
.wave{position:absolute;top:-8px;width:200%;height:20px;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 20'%3E%3Cpath d='M0,10 Q150,0 300,10 Q450,20 600,10 Q750,0 900,10 Q1050,20 1200,10' fill='none' stroke='rgba(255,255,255,0.15)' stroke-width='2'/%3E%3C/svg%3E") repeat-x;animation:waveMove 4s linear infinite}
.wave:nth-child(2){top:-4px;animation-duration:5s;opacity:.5}
@keyframes waveMove{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.1);animation:bubbleRise linear infinite}
@keyframes bubbleRise{0%{transform:translateY(0) scale(1);opacity:.6}100%{transform:translateY(-200px) scale(.3);opacity:0}}
#line-canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:9;pointer-events:none}
#hud{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:flex-start;z-index:100;pointer-events:none}
#hud>*{pointer-events:auto}
.hud-panel{background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 16px}
#money-display{font-family:'Permanent Marker',cursive;font-size:1.5rem;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.5)}
#rod-info{font-size:.85rem;opacity:.8;margin-top:4px}
#collection-info{font-size:.8rem;opacity:.6;margin-top:4px}
#cast-count{font-size:.75rem;opacity:.4;margin-top:2px}
#shop-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a;border:none;border-radius:12px;padding:10px 20px;font-family:'Noto Sans JP',sans-serif;font-weight:900;font-size:1rem;cursor:pointer;transition:all .2s;box-shadow:0 4px 15px rgba(255,215,0,.3)}
#shop-btn:hover{transform:scale(1.05)}
.hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
/* Á´ø„ÅÆÂÖàÔºàÂõ∫ÂÆö‰ΩçÁΩÆÔºâ */
#rod-tip{position:absolute;top:20%;left:52%;width:6px;height:6px;z-index:10;pointer-events:none}
#fishing-line{position:absolute;top:28%;left:50%;width:2px;height:0;background:linear-gradient(180deg,#ccc,#888);transform-origin:top center;z-index:10;transition:height .5s ease;display:none}
#hook{position:absolute;bottom:-10px;left:-5px;width:12px;height:12px;border:2px solid #aaa;border-top:none;border-left:none;border-radius:0 0 8px 0;transform:rotate(45deg)}
#bait{position:absolute;bottom:-18px;left:-4px;font-size:10px}
#cast-area{position:absolute;bottom:0;left:0;right:0;height:50%;display:flex;align-items:center;justify-content:center;z-index:50;cursor:pointer}
#cast-btn{font-family:'Permanent Marker',cursive;font-size:2rem;color:#fff;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50%;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;animation:castPulse 2s ease-in-out infinite}
#cast-btn:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
@keyframes castPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.2)}50%{box-shadow:0 0 0 20px rgba(255,255,255,0)}}
#approaching-fish{position:absolute;z-index:12;display:none;filter:drop-shadow(0 0 8px rgba(255,255,255,.3));pointer-events:none}
#bite-scene{position:absolute;z-index:15;display:none;text-align:center;pointer-events:none}
#bite-scene .bite-fish{animation:biteChomp .25s ease-in-out infinite alternate}
#bite-scene .bite-label{background:rgba(0,0,0,.75);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:4px 14px;font-size:.9rem;font-weight:700;white-space:nowrap;margin-top:6px;display:inline-block}
#bite-scene .bite-size{font-size:.75rem;opacity:.6;margin-top:2px}
#bite-scene .bite-rarity{font-size:.7rem;margin-top:2px;padding:2px 8px;border-radius:10px;display:inline-block}
@keyframes biteChomp{0%{transform:rotate(-10deg) scale(1)}100%{transform:rotate(10deg) scale(1.15)}}
.splash{position:absolute;width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.5);animation:splashExpand .6s ease-out forwards;pointer-events:none;z-index:14}
@keyframes splashExpand{0%{transform:translate(-50%,-50%) scale(0);opacity:1}100%{transform:translate(-50%,-50%) scale(3);opacity:0}}
#hit-banner{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:20;font-family:'Permanent Marker',cursive;font-size:3rem;color:var(--danger);text-shadow:0 0 20px var(--danger),0 0 40px rgba(255,0,0,.3);pointer-events:none;transition:transform .2s cubic-bezier(.175,.885,.32,1.275);white-space:nowrap}
#hit-banner.show{transform:translate(-50%,-50%) scale(1)}
#fighting-fish{position:absolute;z-index:11;display:none;pointer-events:none;filter:drop-shadow(0 0 12px rgba(255,255,255,.4))}
/* Èá£„Çä‰∏ä„ÅíÊºîÂá∫Áî® */
#catch-anim-fish{position:absolute;z-index:200;pointer-events:none;display:none;transition:none}
#fight-ui{position:absolute;bottom:14%;left:50%;transform:translateX(-50%);text-align:center;z-index:60;display:none;width:340px}
#fight-fish-display{font-size:1rem;margin-bottom:4px;font-weight:700}
#distance-display{font-family:'Permanent Marker',cursive;font-size:1.5rem;margin-bottom:6px;text-shadow:0 0 10px rgba(255,255,255,.3)}
#distance-display .dist-num{font-size:2rem;transition:color .2s}
#fight-bar-container{width:100%;height:26px;background:rgba(0,0,0,.5);border-radius:13px;border:2px solid rgba(255,255,255,.2);overflow:hidden;position:relative;margin-bottom:8px}
#fight-bar{height:100%;width:50%;border-radius:11px;transition:width .1s}
#fight-bar-label{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.8);pointer-events:none}
#fight-instruction{font-size:1rem;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.8);animation:fightFlash .5s ease-in-out infinite alternate}
@keyframes fightFlash{0%{opacity:.7}100%{opacity:1}}
#space-hint{margin-top:6px;font-size:.78rem;opacity:.5}
#space-hint kbd{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:4px;padding:2px 8px;font-family:monospace}
.ripple{position:absolute;width:20px;height:6px;border:1px solid rgba(255,255,255,.3);border-radius:50%;animation:rippleOut 1.5s ease-out infinite;pointer-events:none;z-index:11}
@keyframes rippleOut{0%{transform:translate(-50%,-50%) scale(1);opacity:.6}100%{transform:translate(-50%,-50%) scale(4);opacity:0}}
#waiting-text{position:absolute;top:38%;left:50%;transform:translateX(-50%);font-size:.95rem;opacity:.4;z-index:15;display:none}
#catch-popup,#escaped-popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(0,0,0,.88);backdrop-filter:blur(20px);border-radius:20px;padding:30px 40px;text-align:center;z-index:300;transition:transform .4s cubic-bezier(.175,.885,.32,1.275)}
#catch-popup{border:2px solid var(--gold)}#escaped-popup{border:2px solid var(--danger)}
#catch-popup.show,#escaped-popup.show{transform:translate(-50%,-50%) scale(1)}
.fish-emoji{font-size:4rem;margin-bottom:10px}.fish-name{font-family:'Permanent Marker',cursive;font-size:1.8rem;color:var(--gold)}
.fish-size{font-size:1.1rem;margin:6px 0;opacity:.8}.fish-reward{font-size:1.4rem;color:var(--gold);font-weight:900;margin:10px 0}
.rarity-tag{display:inline-block;font-size:.7rem;font-weight:900;padding:2px 10px;border-radius:20px;margin-bottom:6px}
.rarity-common{background:rgba(255,255,255,.15);color:#aaa}.rarity-uncommon{background:rgba(68,255,136,.15);color:var(--success)}.rarity-rare{background:rgba(68,136,255,.2);color:#66aaff}.rarity-epic{background:rgba(180,80,255,.2);color:#bb77ff}
.rarity-legendary{background:rgba(255,215,0,.2);color:var(--gold);animation:legendGlow 1s ease-in-out infinite alternate}
.rarity-mythic{background:rgba(255,50,50,.25);color:#ff4466;animation:mythicGlow .8s ease-in-out infinite alternate}
@keyframes legendGlow{0%{box-shadow:0 0 5px rgba(255,215,0,.3)}100%{box-shadow:0 0 15px rgba(255,215,0,.6)}}
@keyframes mythicGlow{0%{box-shadow:0 0 5px rgba(255,50,80,.3)}100%{box-shadow:0 0 20px rgba(255,50,80,.7)}}
.new-badge{display:inline-block;background:var(--success);color:#1a1a1a;font-size:.75rem;font-weight:900;padding:2px 10px;border-radius:20px;margin-bottom:6px}
.close-btn{background:var(--gold);color:#1a1a1a;border:none;border-radius:10px;padding:8px 30px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;margin-top:10px}
#shop-modal{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:400;display:none;align-items:center;justify-content:center}
#shop-modal.show{display:flex}
#shop-content{background:linear-gradient(135deg,#1a2a4a,#0d1a30);border:2px solid var(--gold);border-radius:20px;padding:30px;width:90%;max-width:500px;max-height:85vh;overflow-y:auto}
#shop-content h2{font-family:'Permanent Marker',cursive;font-size:1.8rem;color:var(--gold);text-align:center;margin-bottom:6px}
#shop-money{text-align:center;color:var(--gold);font-weight:700;margin-bottom:16px;font-size:1.1rem}
.shop-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;transition:all .2s}.shop-item:hover{background:rgba(255,255,255,.1)}.shop-item.owned{border-color:var(--success);background:rgba(68,255,136,.05)}.shop-item.equipped{border-color:var(--gold);background:rgba(255,215,0,.1)}.shop-item-info h3{font-size:1rem;margin-bottom:4px}.shop-item-info p{font-size:.8rem;opacity:.6}.shop-item-info .stats{font-size:.8rem;color:var(--success);margin-top:2px}
.buy-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700;font-size:.85rem;cursor:pointer;white-space:nowrap;font-family:'Noto Sans JP',sans-serif}.buy-btn:disabled{opacity:.4;cursor:not-allowed}.buy-btn.equip-btn{background:linear-gradient(135deg,#44aaff,#2266aa);color:#fff}.buy-btn.equipped-btn{background:rgba(255,215,0,.3);color:var(--gold)}
#shop-close{display:block;margin:16px auto 0;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px 30px;font-size:1rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.swimming-fish{position:absolute;font-size:1.5rem;z-index:5;opacity:.15;pointer-events:none}
.sparkle{position:absolute;width:6px;height:6px;background:var(--gold);border-radius:50%;pointer-events:none;z-index:350;animation:sparkleFade .8s ease-out forwards}
@keyframes sparkleFade{0%{transform:scale(1);opacity:1}100%{transform:scale(0) translate(var(--dx),var(--dy));opacity:0}}
@keyframes lineShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}
</style>
</head>
<body>
<div id="game-container">
  <div id="sky"><div id="sun"></div></div>
  <div id="water"><div class="wave"></div><div class="wave"></div></div>
  <canvas id="line-canvas"></canvas>
  <div id="rod-tip"></div>
  <div id="fishing-line"><div id="hook"></div><div id="bait">ü™±</div></div>
  <div id="approaching-fish"></div>
  <div id="bite-scene"><div class="bite-fish"></div><div class="bite-label"></div><div class="bite-size"></div><div class="bite-rarity"></div></div>
  <div id="hit-banner">‚ÄºÔ∏è HIT!</div>
  <div id="fighting-fish"></div>
  <div id="catch-anim-fish"></div>
  <div id="waiting-text">È≠ö„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</div>
  <div id="hud"><div class="hud-panel"><div id="money-display">üí∞ 0G</div><div id="rod-info">üéã Á´π„ÅÆÁ´ø</div><div id="collection-info">üìñ 0 / 20Á®Æ</div><div id="cast-count">üé£ 0ÂõûÁõÆ</div></div><div class="hud-right"><button id="shop-btn">üõí „Ç∑„Éß„ÉÉ„Éó</button><button id="reset-btn" style="background:rgba(255,50,50,.3);color:#ff8888;border:1px solid rgba(255,50,50,.3);border-radius:10px;padding:8px 14px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:.75rem;cursor:pointer" onclick="resetSave()">üóëÔ∏è „É™„Çª„ÉÉ„Éà</button></div></div>
  <div id="cast-area"><div id="cast-btn">üé£<br><span style="font-size:.55rem;font-family:'Noto Sans JP'">„Çø„ÉÉ„Éó or SPACE</span></div></div>
  <div id="fight-ui"><div id="fight-fish-display"></div><div id="distance-display">ÊÆã„Çä <span class="dist-num" id="dist-num">0</span> m</div><div id="fight-bar-container"><div id="fight-bar"></div><div id="fight-bar-label"></div></div><div id="fight-instruction">üî• „Çπ„Éö„Éº„Çπ„ÇíÊäº„Åó„Å¶Èõ¢„ÅõÔºÅ</div><div id="space-hint"><kbd>SPACE</kbd> Êäº„Åó„Å¶Èõ¢„Åô or „Çø„ÉÉ„Éó</div></div>
  <div id="catch-popup"><div class="fish-emoji" id="catch-emoji"></div><div id="catch-rarity-tag" class="rarity-tag" style="display:none"></div><div id="catch-new-badge" class="new-badge" style="display:none">NEW!</div><div class="fish-name" id="catch-name"></div><div class="fish-size" id="catch-size"></div><div class="fish-reward" id="catch-reward"></div><button class="close-btn" onclick="closeCatchPopup()">OK!</button></div>
  <div id="escaped-popup"><div style="font-size:3rem;margin-bottom:10px">üí®</div><div style="font-size:1.3rem;font-weight:700;color:var(--danger)">ÈÄÉ„Åí„Çâ„Çå„Åü‚Ä¶ÔºÅ</div><div style="font-size:.9rem;opacity:.6;margin:8px 0" id="escaped-fish-name"></div><button class="close-btn" style="background:var(--danger);color:white" onclick="closeEscapedPopup()">OK</button></div>
  <div id="shop-modal"><div id="shop-content"><h2>üõí „Ç∑„Éß„ÉÉ„Éó</h2><div id="shop-money"></div><div id="shop-items"></div><button id="shop-close" onclick="closeShop()">Èñâ„Åò„Çã</button></div></div>
</div>
<script>
const canvas=document.getElementById('line-canvas'),ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
resizeCanvas();window.addEventListener('resize',resizeCanvas);

let money=0,equippedRod='bamboo',ownedRods=['bamboo'],caughtSpecies=new Set(),gameState='idle',totalCasts=0;
const FISH=[
{id:'sardine',name:'„Ç§„ÉØ„Ç∑',emoji:'üêü',minSize:10,maxSize:25,basePrice:8,difficulty:0.22,rarity:0.32,depth:'shallow',color:'#88aacc',tier:'common'},
{id:'horse_mackerel',name:'„Ç¢„Ç∏',emoji:'üêü',minSize:15,maxSize:35,basePrice:15,difficulty:0.27,rarity:0.28,depth:'shallow',color:'#7799bb',tier:'common'},
{id:'squid',name:'„Ç§„Ç´',emoji:'ü¶ë',minSize:20,maxSize:50,basePrice:20,difficulty:0.32,rarity:0.22,depth:'shallow',color:'#cc8899',tier:'common'},
{id:'sea_bream',name:'„Çø„Ç§',emoji:'üê°',minSize:30,maxSize:70,basePrice:50,difficulty:0.48,rarity:0.10,depth:'mid',color:'#ee7788',tier:'uncommon'},
{id:'flounder',name:'„Éí„É©„É°',emoji:'üê†',minSize:35,maxSize:80,basePrice:65,difficulty:0.52,rarity:0.08,depth:'mid',color:'#99bb77',tier:'uncommon'},
{id:'octopus',name:'„Çø„Ç≥',emoji:'üêô',minSize:30,maxSize:60,basePrice:55,difficulty:0.55,rarity:0.08,depth:'mid',color:'#cc6677',tier:'uncommon'},
{id:'yellowtail',name:'„Éñ„É™',emoji:'üêü',minSize:50,maxSize:120,basePrice:120,difficulty:0.65,rarity:0.030,depth:'deep',color:'#aabb44',tier:'rare'},
{id:'tuna',name:'„Éû„Ç∞„É≠',emoji:'üêü',minSize:80,maxSize:200,basePrice:200,difficulty:0.73,rarity:0.020,depth:'deep',color:'#4466aa',tier:'rare'},
{id:'swordfish',name:'„Ç´„Ç∏„Ç≠',emoji:'üó°Ô∏è',minSize:100,maxSize:300,basePrice:350,difficulty:0.80,rarity:0.012,depth:'deep',color:'#5577cc',tier:'rare'},
{id:'manta',name:'„Éû„É≥„Çø',emoji:'ü¶Ö',minSize:200,maxSize:500,basePrice:400,difficulty:0.78,rarity:0.010,depth:'deep',color:'#446688',tier:'rare'},
{id:'shark',name:'„Çµ„É°',emoji:'ü¶à',minSize:150,maxSize:400,basePrice:600,difficulty:0.88,rarity:0.005,depth:'deep',color:'#667788',tier:'epic'},
{id:'whale_shark',name:'„Ç∏„É≥„Éô„Ç®„Ç∂„É°',emoji:'üêã',minSize:400,maxSize:800,basePrice:1500,difficulty:0.92,rarity:0.003,depth:'deep',color:'#5566aa',tier:'epic'},
{id:'oarfish',name:'„É™„É•„Ç¶„Ç∞„Ç¶„Éé„ÉÑ„Ç´„Ç§',emoji:'üêç',minSize:300,maxSize:600,basePrice:2000,difficulty:0.93,rarity:0.0025,depth:'deep',color:'#cc44aa',tier:'epic'},
{id:'giant_squid',name:'„ÉÄ„Ç§„Ç™„Ç¶„Ç§„Ç´',emoji:'ü¶ë',minSize:500,maxSize:1200,basePrice:2500,difficulty:0.95,rarity:0.002,depth:'deep',color:'#883366',tier:'epic'},
{id:'coelacanth',name:'„Ç∑„Éº„É©„Ç´„É≥„Çπ',emoji:'üê†',minSize:150,maxSize:200,basePrice:5000,difficulty:0.96,rarity:0.0010,depth:'deep',color:'#3355aa',tier:'legendary'},
{id:'golden_fish',name:'ÈªÑÈáë„ÅÆÈ≠ö',emoji:'‚ú®',minSize:30,maxSize:50,basePrice:8000,difficulty:0.88,rarity:0.0007,depth:'deep',color:'#ffcc00',tier:'legendary'},
{id:'megalodon',name:'„É°„Ç¨„É≠„Éâ„É≥',emoji:'ü¶à',minSize:1000,maxSize:2000,basePrice:12000,difficulty:0.98,rarity:0.0005,depth:'deep',color:'#554455',tier:'legendary'},
{id:'dragon',name:'ÈæçÈ≠ö',emoji:'üêâ',minSize:500,maxSize:1000,basePrice:20000,difficulty:0.99,rarity:0.00035,depth:'deep',color:'#ff6622',tier:'mythic'},
{id:'leviathan',name:'„É™„É¥„Ç°„Ç§„Ç¢„Çµ„É≥',emoji:'üåä',minSize:2000,maxSize:5000,basePrice:50000,difficulty:1.0,rarity:0.00015,depth:'deep',color:'#2244aa',tier:'mythic'},
{id:'void_fish',name:'ËôöÁÑ°„ÅÆÈ≠ö',emoji:'üï≥Ô∏è',minSize:1,maxSize:1,basePrice:99999,difficulty:0.95,rarity:0.0001,depth:'deep',color:'#220033',tier:'mythic'},
];
const TIER_INFO={common:{label:'„Ç≥„É¢„É≥',cls:'rarity-common'},uncommon:{label:'„Ç¢„É≥„Ç≥„É¢„É≥',cls:'rarity-uncommon'},rare:{label:'‚òÖ „É¨„Ç¢',cls:'rarity-rare'},epic:{label:'‚òÖ‚òÖ „Ç®„Éî„ÉÉ„ÇØ',cls:'rarity-epic'},legendary:{label:'‚òÖ‚òÖ‚òÖ ‰ºùË™¨',cls:'rarity-legendary'},mythic:{label:'‚ú¶ Á•ûË©±',cls:'rarity-mythic'}};
const RODS=[
{id:'bamboo',name:'Á´π„ÅÆÁ´ø',emoji:'üéã',price:0,power:1.0,luck:1.0,desc:'ÂàùÂøÉËÄÖÁî®„ÅÆÁ´ø',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ ÈÅã:‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ'},
{id:'fiber',name:'„Ç∞„É©„Çπ„Éï„Ç°„Ç§„Éê„ÉºÁ´ø',emoji:'üé£',price:200,power:1.4,luck:1.1,desc:'ËªΩ„Åè„Å¶‰∏àÂ§´',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ ÈÅã:‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ'},
{id:'carbon',name:'„Ç´„Éº„Éú„É≥Á´ø',emoji:'‚ö°',price:600,power:1.8,luck:1.3,desc:'„Éó„É≠‰ªïÊßò',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ ÈÅã:‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ'},
{id:'titanium',name:'„ÉÅ„Çø„É≥ÂêàÈáëÁ´ø',emoji:'üî©',price:1800,power:2.3,luck:1.5,desc:'Â§ßÁâ©„ÇÇÂºï„Åë„Çã',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ ÈÅã:‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ'},
{id:'golden_rod',name:'ÈªÑÈáë„ÅÆÁ´ø',emoji:'‚ú®',price:5000,power:2.8,luck:2.0,desc:'„É¨„Ç¢È≠ö„ÅåÂá∫„ÇÑ„Åô„ÅÑ',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ ÈÅã:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'},
{id:'mithril',name:'„Éü„Çπ„É™„É´„É≠„ÉÉ„Éâ',emoji:'üíé',price:15000,power:3.5,luck:2.8,desc:'Âè§‰ª£„ÅÆÈáëÂ±û',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ÈÅã:‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ'},
{id:'abyssal',name:'Ê∑±Ê∑µ„ÅÆÁ´ø',emoji:'üåÄ',price:40000,power:4.2,luck:3.5,desc:'Ê∑±Êµ∑„ÅÆÈ≠îÂäõ',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ+ ÈÅã:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'},
{id:'divine',name:'Á•ûÁ´ø„ÄåÊµ∑Á•û„Äç',emoji:'üî±',price:100000,power:5.5,luck:5.0,desc:'Á•ûË©±„Åô„ÇâÈá£„Çã',stats:'„Éë„ÉØ„Éº:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ++ ÈÅã:‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ++'},
];

function getRod(){return RODS.find(r=>r.id===equippedRod)}
function pickFish(){const rod=getRod();let pool=FISH.map(f=>{let w=f.rarity;if(f.tier==='rare')w*=rod.luck;if(f.tier==='epic')w*=Math.pow(rod.luck,1.5);if(f.tier==='legendary')w*=Math.pow(rod.luck,2);if(f.tier==='mythic')w*=Math.pow(rod.luck,2.5);if(f.depth==='deep'&&rod.power<1.5)w*=0.25;return{...f,weight:w}});const t=pool.reduce((s,f)=>s+f.weight,0);let r=Math.random()*t;for(const f of pool){r-=f.weight;if(r<=0)return f}return pool[0]}
function randomSize(f){return Math.round(f.minSize+(f.maxSize-f.minSize)*Math.pow(Math.random(),1.5))}
function calcReward(f,s){return Math.round(f.basePrice*(s/f.minSize)*(0.8+Math.random()*0.4))}
function getFishScale(f,s){return 1.5+Math.min(((s-f.minSize)/Math.max(1,f.maxSize-f.minSize))*2.5,3)}
function calcStartDistance(f,s){return Math.round((7+f.difficulty*35+(s/f.maxSize)*8)*10)/10}
function updateHUD(){document.getElementById('money-display').textContent='üí∞ '+money.toLocaleString()+'G';const rod=getRod();document.getElementById('rod-info').textContent=rod.emoji+' '+rod.name;document.getElementById('collection-info').textContent='üìñ '+caughtSpecies.size+' / '+FISH.length+'Á®Æ';document.getElementById('cast-count').textContent='üé£ '+totalCasts+'ÂõûÁõÆ'}

// BG
function spawnBgFish(){const w=document.getElementById('water'),f=FISH[Math.floor(Math.random()*6)];const el=document.createElement('div');el.className='swimming-fish';el.textContent=f.emoji;el.style.top=(20+Math.random()*60)+'%';el.style.fontSize=(1+Math.random())+'rem';el.style.opacity=.12+Math.random()*.12;const dur=(8+Math.random()*12)*1000;const goR=Math.random()>.5;if(goR){el.style.left='-40px';el.style.transform='scaleX(1)';el.animate([{left:'-40px'},{left:'calc(100% + 40px)'}],{duration:dur,fill:'forwards'}).onfinish=function(){el.remove()}}else{el.style.left='calc(100% + 40px)';el.style.transform='scaleX(-1)';el.animate([{left:'calc(100% + 40px)'},{left:'-40px'}],{duration:dur,fill:'forwards'}).onfinish=function(){el.remove()}}w.appendChild(el)}
setInterval(spawnBgFish,3000);
setInterval(function(){const w=document.getElementById('water'),b=document.createElement('div');b.className='bubble';const s=4+Math.random()*8;b.style.width=s+'px';b.style.height=s+'px';b.style.left=Math.random()*100+'%';b.style.top=(30+Math.random()*60)+'%';b.style.animationDuration=(2+Math.random()*4)+'s';w.appendChild(b);b.addEventListener('animationend',function(){b.remove()})},800);

// ===== GAME =====
let currentFish=null,currentSize=0,fightInterval=null,approachAnim=null;
let spaceDown=false,fishDistance=0,maxDistance=0,startDistance=0;
let fishScreenX=0,fishScreenY=0,lineMode='none',lineShake=0; // lineMode: none, waiting, fighting, catching

// Á´øÂÖà„ÅÆÂ∫ßÊ®ô„ÇíÂèñÂæó
function getRodTipPos(){
  var rt=document.getElementById('rod-tip').getBoundingClientRect();
  return{x:rt.left+rt.width/2, y:rt.top+rt.height/2};
}

document.addEventListener('keydown',function(e){if(e.code==='Space'||e.code==='Enter'){e.preventDefault();if(e.code==='Space')spaceDown=true}});
document.addEventListener('keyup',function(e){if(e.code==='Space'){e.preventDefault();if(!spaceDown)return;spaceDown=false;if(document.getElementById('catch-popup').classList.contains('show')){closeCatchPopup();return}if(document.getElementById('escaped-popup').classList.contains('show')){closeEscapedPopup();return}handleAction()}if(e.code==='Enter'){if(document.getElementById('catch-popup').classList.contains('show')){closeCatchPopup();return}if(document.getElementById('escaped-popup').classList.contains('show')){closeEscapedPopup();return}handleAction()}});
document.getElementById('cast-area').addEventListener('click',handleAction);

function handleAction(){if(document.getElementById('shop-modal').classList.contains('show'))return;if(document.getElementById('catch-popup').classList.contains('show'))return;if(document.getElementById('escaped-popup').classList.contains('show'))return;if(gameState==='idle')startCasting();else if(gameState==='bite')startFight();else if(gameState==='fighting')reel()}
function getHookPos(){var r=document.getElementById('fishing-line').getBoundingClientRect();return{x:r.left+r.width/2,y:r.bottom}}

function startCasting(){
  gameState='casting';totalCasts++;updateHUD();document.getElementById('cast-btn').style.display='none';
  var fl=document.getElementById('fishing-line');fl.style.display='block';fl.style.height='0px';fl.style.animation='none';lineMode='none';
  setTimeout(function(){fl.style.height='38%';gameState='waiting';document.getElementById('waiting-text').style.display='block';lineMode='waiting';
    setTimeout(function(){var hp=getHookPos();fishScreenX=hp.x;fishScreenY=hp.y;var r=document.createElement('div');r.className='ripple';r.style.left=hp.x+'px';r.style.top=hp.y+'px';document.getElementById('game-container').appendChild(r);setTimeout(function(){r.remove()},3000)},600);
    setTimeout(function(){if(gameState==='waiting'){currentFish=pickFish();currentSize=randomSize(currentFish);startApproach()}},1200+Math.random()*2500);
  },100);
}

function startApproach(){
  if(gameState!=='waiting')return;var hp=getHookPos(),scale=getFishScale(currentFish,currentSize),fromL=Math.random()>.5;
  var af=document.getElementById('approaching-fish');af.textContent=currentFish.emoji;af.style.fontSize=scale+'rem';af.style.display='block';af.style.top=(hp.y-10)+'px';
  var sx=fromL?-80:window.innerWidth+80,ex=hp.x-20;af.style.left=sx+'px';af.style.transform=fromL?'scaleX(1)':'scaleX(-1)';
  var dur=1000+Math.random()*800;var st=null;
  function anim(ts){if(!st)st=ts;var el=ts-st,p=Math.min(el/dur,1);var e=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;af.style.left=(sx+(ex-sx)*e)+'px';af.style.top=(hp.y-10+Math.sin(el/120)*4)+'px';if(p<1&&gameState==='waiting')approachAnim=requestAnimationFrame(anim);else if(p>=1)triggerBite()}
  approachAnim=requestAnimationFrame(anim);
}

function triggerBite(){
  gameState='bite';document.getElementById('approaching-fish').style.display='none';document.getElementById('waiting-text').style.display='none';
  var hp=getHookPos(),scale=getFishScale(currentFish,currentSize),bs=document.getElementById('bite-scene');
  bs.querySelector('.bite-fish').textContent=currentFish.emoji;bs.querySelector('.bite-fish').style.fontSize=scale+'rem';
  bs.querySelector('.bite-label').textContent=currentFish.name+'„ÅåÈ£ü„ÅÑ„Å§„ÅÑ„ÅüÔºÅ';bs.querySelector('.bite-size').textContent='Êé®ÂÆö '+currentSize+'cm';
  var ti=TIER_INFO[currentFish.tier],br=bs.querySelector('.bite-rarity');br.textContent=ti.label;br.className='bite-rarity '+ti.cls;
  bs.style.left=hp.x+'px';bs.style.top=(hp.y-10)+'px';bs.style.display='block';document.getElementById('hit-banner').classList.add('show');
  for(var i=0;i<3;i++){(function(i){setTimeout(function(){var s=document.createElement('div');s.className='splash';s.style.left=(hp.x+(Math.random()-.5)*40)+'px';s.style.top=(hp.y+(Math.random()-.5)*20)+'px';document.getElementById('game-container').appendChild(s);setTimeout(function(){s.remove()},600)},i*150)})(i)}
  if(navigator.vibrate)navigator.vibrate([100,50,100,50,200]);
  document.getElementById('fishing-line').style.animation='lineShake .1s ease-in-out 15';
  setTimeout(function(){if(gameState==='bite')fishEscaped()},2500);
}

function startFight(){
  gameState='fighting';document.getElementById('bite-scene').style.display='none';document.getElementById('hit-banner').classList.remove('show');
  // ÈùôÁöÑ„Å™Èá£„ÇäÁ≥∏„ÇíÊ∂à„Åó„Å¶„Ç≠„É£„É≥„Éê„ÇπÊèèÁîª„Å´
  document.getElementById('fishing-line').style.display='none';document.getElementById('fishing-line').style.animation='none';
  lineMode='fighting';
  document.getElementById('fight-ui').style.display='block';
  var scale=getFishScale(currentFish,currentSize),ti=TIER_INFO[currentFish.tier];
  document.getElementById('fight-fish-display').innerHTML='<span style="font-size:'+Math.min(scale*.6,2)+'rem">'+currentFish.emoji+'</span> '+currentFish.name+' '+currentSize+'cm <span class="rarity-tag '+ti.cls+'" style="font-size:.65rem">'+ti.label+'</span>';
  var ff=document.getElementById('fighting-fish');ff.textContent=currentFish.emoji;ff.style.fontSize=scale+'rem';ff.style.display='block';
  startDistance=calcStartDistance(currentFish,currentSize);fishDistance=startDistance;maxDistance=startDistance*1.7;
  updateDistanceUI();
  var rod=getRod();var eff=(currentFish.difficulty*(0.65+0.35*currentSize/currentFish.maxSize))/(rod.power*0.45);
  var pullRate=0.025+eff*0.09;var jerkChance=eff*0.04;var jerkPower=0.6+eff*1.2;
  var tick=0;
  fightInterval=setInterval(function(){tick++;fishDistance+=pullRate;
    if(Math.random()<jerkChance){fishDistance+=jerkPower*(0.5+Math.random());lineShake=10}
    if(lineShake>0)lineShake-=0.5;
    var dr=Math.min(fishDistance/maxDistance,1);
    // È≠ö„ÅÆÁîªÈù¢Â∫ßÊ®ôÔºàÊ∞¥Èù¢‰ªòËøëÔΩûÁîªÈù¢Âè≥‰∏ãÊñπÂêë„Å∏Ôºâ
    var waterTop=window.innerHeight*0.30;
    var fx=window.innerWidth*0.50+dr*window.innerWidth*0.35;
    var fy=waterTop+20+dr*window.innerHeight*0.25+Math.sin(tick*.07)*10;
    ff.style.left=fx+'px';ff.style.top=fy+'px';
    ff.style.transform='scale('+Math.max(.4,1-dr*.5)+')';
    fishScreenX=fx;fishScreenY=fy;
    if(fishDistance>=maxDistance)fishEscaped();updateDistanceUI();
  },50);
}

// „Ç≠„É£„É≥„Éê„ÇπÊèèÁîª„É´„Éº„ÉóÔºöÁ´øÂÖà‚ÜíÈ≠ö„Çí„Å§„Å™„ÅêÁ≥∏
function drawLineLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(lineMode==='fighting'||lineMode==='catching'){
    var tip=getRodTipPos();
    var fx=fishScreenX,fy=fishScreenY;
    var dx=fx-tip.x,dy=fy-tip.y;
    var dist=Math.sqrt(dx*dx+dy*dy);

    // „Åü„Çã„ÅøÔºàË∑ùÈõ¢„ÅåÈÅ†„ÅÑ„Åª„Å©„Åü„Çã„ÇÄ„ÄÅËøë„ÅÑ„Å®„Éî„É≥Âºµ„ÇäÔºâ
    var tensionRatio=lineMode==='catching'?1:Math.max(0,1-fishDistance/maxDistance);
    var sag=(1-tensionRatio)*Math.min(dist*0.2,80);

    // „Ç∏„É£„Éº„ÇØÊè∫„Çå
    var sx=lineShake>0?(Math.random()-.5)*lineShake*3:0;

    // Ëâ≤ÔºöËøë„ÅÑ=ÁôΩ„Å£„ÅΩ„ÅÑ„ÄÅÈÅ†„ÅÑ=Ëµ§„Å£„ÅΩ„ÅÑ
    var r,g,b,alpha=0.95;
    if(lineMode==='catching'){r=200;g=255;b=200}
    else if(tensionRatio>0.6){r=220;g=240;b=220}
    else if(tensionRatio>0.3){r=240;g=200;b=100}
    else{r=255;g=100;b=80}

    // Á∑ö„ÅÆÂ§™„ÅïÔºö„ÉÜ„É≥„Ç∑„Éß„É≥È´ò„ÅÑ=Â§™„ÅÑ
    ctx.lineWidth=lineMode==='catching'?3.5:2+tensionRatio*2;
    ctx.strokeStyle='rgba('+r+','+g+','+b+','+alpha+')';
    ctx.shadowColor='rgba('+r+','+g+','+b+',0.5)';
    ctx.shadowBlur=lineMode==='catching'?12:4+tensionRatio*6;
    ctx.lineCap='round';

    // 2Ê¨°„Éô„Ç∏„ÇßÊõ≤Á∑öÔºà‰∏≠ÈñìÁÇπ„Çí„Åü„Çã„Åæ„Åõ„ÇãÔºâ
    var mx=(tip.x+fx)/2+sx;
    var my=(tip.y+fy)/2+sag;

    ctx.beginPath();
    ctx.moveTo(tip.x,tip.y);
    ctx.quadraticCurveTo(mx,my,fx+sx*0.5,fy);
    ctx.stroke();
    ctx.shadowBlur=0;

    // „ÉÜ„É≥„Ç∑„Éß„É≥È´ò„ÅÑÊôÇ„Å´Á≥∏„Å´ÂÖâ„ÇãÁÇπ
    if(tensionRatio>0.5){
      var t=Date.now()/400%1;
      var px=tip.x*(1-t)*(1-t)+mx*2*(1-t)*t+fx*t*t;
      var py=tip.y*(1-t)*(1-t)+my*2*(1-t)*t+fy*t*t;
      ctx.fillStyle='rgba(255,255,255,'+(0.3+tensionRatio*0.4)+')';
      ctx.beginPath();ctx.arc(px,py,2,0,Math.PI*2);ctx.fill();
    }
  }
  requestAnimationFrame(drawLineLoop);
}
requestAnimationFrame(drawLineLoop);

function reel(){
  if(gameState!=='fighting')return;var rod=getRod();
  var pp=0.4+rod.power*0.4;fishDistance-=pp;lineShake=3;
  if(fishDistance<=0){fishDistance=0;updateDistanceUI();catchFish();return}
  updateDistanceUI();
}

function updateDistanceUI(){var dn=document.getElementById('dist-num'),dist=Math.max(0,fishDistance);dn.textContent=dist.toFixed(1);var pct=Math.max(0,Math.min(100,(1-dist/maxDistance)*100));var fb=document.getElementById('fight-bar');fb.style.width=pct+'%';if(pct>70)fb.style.background='linear-gradient(90deg,#44cc88,var(--success))';else if(pct>40)fb.style.background='linear-gradient(90deg,var(--gold),#aacc44)';else fb.style.background='linear-gradient(90deg,var(--danger),#cc8844)';document.getElementById('fight-bar-label').textContent='ÊÆã„Çä '+dist.toFixed(1)+'m';var inst=document.getElementById('fight-instruction');if(dist<2){inst.textContent='üî• „ÅÇ„Å®Â∞ë„ÅóÔºÅ';inst.style.color='var(--success)'}else if(dist>startDistance*1.3){inst.textContent='‚ö†Ô∏è Èõ¢„Åï„Çå„Å¶„ÇãÔºÅ';inst.style.color='var(--danger)'}else{inst.textContent='üî• „Çπ„Éö„Éº„Çπ„ÇíÊäº„Åó„Å¶Èõ¢„ÅõÔºÅ';inst.style.color='white'}dn.style.color=dist<2?'var(--success)':dist>startDistance*1.3?'var(--danger)':'var(--gold)'}

// Èá£„Çä‰∏ä„ÅíÊºîÂá∫ÔºöÈ≠ö„ÅåÁ≥∏„Å´Âºï„Åã„Çå„Å¶Ê∞¥Èù¢„Åã„ÇâÈ£õ„Å≥Âá∫„Åô
function catchFish(){
  clearInterval(fightInterval);gameState='idle';
  document.getElementById('fight-ui').style.display='none';
  var ff=document.getElementById('fighting-fish');ff.style.display='none';

  // Èá£„Çä‰∏ä„Åí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
  lineMode='catching';
  var caf=document.getElementById('catch-anim-fish');
  caf.textContent=currentFish.emoji;
  var scale=getFishScale(currentFish,currentSize);
  caf.style.fontSize=scale+'rem';caf.style.display='block';
  var waterTop=window.innerHeight*0.30;
  // ÈñãÂßã‰ΩçÁΩÆÔºöÊ∞¥Èù¢‰ªòËøë„ÅÆ‰∏≠Â§Æ
  var startX=window.innerWidth*0.5,startY=waterTop+20;
  // ÁµÇ‰∫Ü‰ΩçÁΩÆÔºöÁ´øÂÖà„ÅÆÂ∞ë„Åó‰∏ã
  var tip=getRodTipPos();
  var endX=tip.x,endY=tip.y+30;
  fishScreenX=startX;fishScreenY=startY;

  var dur=600;var st=null;
  function anim(ts){
    if(!st)st=ts;var el=ts-st,p=Math.min(el/dur,1);
    // „Ç§„Éº„Ç∫„Ç¢„Ç¶„Éà„ÅßÈ£õ„Å≥‰∏ä„Åå„Çã
    var ep=1-Math.pow(1-p,3);
    var cx=startX+(endX-startX)*ep;
    // YÊñπÂêë„ÅØÂºß„ÇíÊèè„ÅÑ„Å¶‰∏ä„Åå„Çã
    var arcY=-80*Math.sin(p*Math.PI);
    var cy=startY+(endY-startY)*ep+arcY;
    caf.style.left=cx+'px';caf.style.top=cy+'px';
    caf.style.transform='scale('+(1+0.3*Math.sin(p*Math.PI))+') rotate('+(-30*p)+'deg)';
    fishScreenX=cx;fishScreenY=cy;

    // Ê∞¥„Åó„Å∂„ÅçÔºàÈñãÂßãÊôÇÔºâ
    if(el<100&&el>0&&Math.random()<0.3){
      var sp=document.createElement('div');sp.className='splash';
      sp.style.left=(startX+(Math.random()-.5)*60)+'px';sp.style.top=waterTop+'px';
      document.getElementById('game-container').appendChild(sp);setTimeout(function(){sp.remove()},600);
    }

    if(p<1){requestAnimationFrame(anim)}
    else{
      caf.style.display='none';lineMode='none';
      showCatchPopup();
    }
  }
  requestAnimationFrame(anim);
}

function showCatchPopup(){
  var isNew=!caughtSpecies.has(currentFish.id),reward=calcReward(currentFish,currentSize);money+=reward;caughtSpecies.add(currentFish.id);updateHUD();
  document.getElementById('catch-emoji').textContent=currentFish.emoji;document.getElementById('catch-name').textContent=currentFish.name;
  document.getElementById('catch-size').textContent=currentSize+'cm';document.getElementById('catch-reward').textContent='+'+reward.toLocaleString()+'G';
  document.getElementById('catch-new-badge').style.display=isNew?'inline-block':'none';
  var ti=TIER_INFO[currentFish.tier],rt=document.getElementById('catch-rarity-tag');rt.textContent=ti.label;rt.className='rarity-tag '+ti.cls;rt.style.display='inline-block';
  document.getElementById('catch-popup').classList.add('show');
  var sc=currentFish.tier==='mythic'?40:currentFish.tier==='legendary'?30:currentFish.tier==='epic'?20:12;
  for(var i=0;i<sc;i++){var s=document.createElement('div');s.className='sparkle';var a=(i/sc)*Math.PI*2,d=60+Math.random()*50;s.style.left='calc(50% + '+Math.cos(a)*d+'px)';s.style.top='calc(50% + '+Math.sin(a)*d+'px)';s.style.setProperty('--dx',Math.cos(a)*40+'px');s.style.setProperty('--dy',Math.sin(a)*40+'px');s.style.background=currentFish.color||'var(--gold)';document.getElementById('game-container').appendChild(s);setTimeout(function(el){return function(){el.remove()}}(s),1000)}
}

function fishEscaped(){
  clearInterval(fightInterval);if(approachAnim)cancelAnimationFrame(approachAnim);gameState='idle';lineMode='none';
  ['fight-ui','fishing-line','approaching-fish','bite-scene','waiting-text','fighting-fish','catch-anim-fish'].forEach(function(id){var e=document.getElementById(id);e.style.display='none';if(id==='fishing-line')e.style.animation='none'});
  document.getElementById('hit-banner').classList.remove('show');
  document.getElementById('escaped-fish-name').textContent=currentFish?currentFish.emoji+' '+currentFish.name+' ('+currentSize+'cm) „ÅåÈÄÉ„Åí„Åü':'';
  document.getElementById('escaped-popup').classList.add('show');resetCastBtn();
}

function closeCatchPopup(){document.getElementById('catch-popup').classList.remove('show');resetCastBtn()}
function closeEscapedPopup(){document.getElementById('escaped-popup').classList.remove('show');resetCastBtn()}
function resetCastBtn(){document.getElementById('cast-btn').style.display='flex'}

document.getElementById('shop-btn').addEventListener('click',openShop);
function openShop(){var si=document.getElementById('shop-items');si.innerHTML='';document.getElementById('shop-money').textContent='ÊâÄÊåÅÈáë: '+money.toLocaleString()+'G';RODS.forEach(function(rod){var owned=ownedRods.includes(rod.id),equipped=equippedRod===rod.id,canBuy=money>=rod.price&&!owned;var div=document.createElement('div');div.className='shop-item'+(equipped?' equipped':owned?' owned':'');var btn;if(equipped)btn='<button class="buy-btn equipped-btn" disabled>Ë£ÖÂÇô‰∏≠</button>';else if(owned)btn='<button class="buy-btn equip-btn" onclick="equipRod(\''+rod.id+'\')">Ë£ÖÂÇô</button>';else if(rod.price===0)btn='';else btn='<button class="buy-btn" '+(canBuy?'':'disabled')+' onclick="buyRod(\''+rod.id+'\')">'+rod.price.toLocaleString()+'G</button>';div.innerHTML='<div class="shop-item-info"><h3>'+rod.emoji+' '+rod.name+'</h3><p>'+rod.desc+'</p><div class="stats">'+rod.stats+'</div></div>'+btn;si.appendChild(div)});document.getElementById('shop-modal').classList.add('show')}
function buyRod(id){var rod=RODS.find(function(r){return r.id===id});if(money>=rod.price&&!ownedRods.includes(id)){money-=rod.price;ownedRods.push(id);equippedRod=id;updateHUD();openShop()}}
function equipRod(id){if(ownedRods.includes(id)){equippedRod=id;updateHUD();openShop()}}
function closeShop(){document.getElementById('shop-modal').classList.remove('show')}
// ===== SAVE / LOAD =====
function saveGame(){
  var data={money:money,equippedRod:equippedRod,ownedRods:ownedRods,caughtSpecies:Array.from(caughtSpecies),totalCasts:totalCasts,ver:2};
  try{localStorage.setItem('fishing_save',JSON.stringify(data))}catch(e){}
}
function loadGame(){
  try{
    var raw=localStorage.getItem('fishing_save');
    if(!raw)return;
    var d=JSON.parse(raw);
    if(d.money!=null)money=d.money;
    if(d.equippedRod)equippedRod=d.equippedRod;
    if(d.ownedRods)ownedRods=d.ownedRods;
    if(d.caughtSpecies)caughtSpecies=new Set(d.caughtSpecies);
    if(d.totalCasts!=null)totalCasts=d.totalCasts;
  }catch(e){}
}
function resetSave(){
  if(confirm('„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')){
    localStorage.removeItem('fishing_save');
    money=0;equippedRod='bamboo';ownedRods=['bamboo'];caughtSpecies=new Set();totalCasts=0;
    updateHUD();
  }
}

// Èá£„Çä‰∏ä„Åí„ÉªË≥ºÂÖ•ÊôÇ„Å´„Ç™„Éº„Éà„Çª„Éº„Éñ
var _origShowCatch=showCatchPopup;
showCatchPopup=function(){_origShowCatch();saveGame()};
var _origBuyRod=buyRod;
buyRod=function(id){_origBuyRod(id);saveGame()};
var _origEquipRod=equipRod;
equipRod=function(id){_origEquipRod(id);saveGame()};

loadGame();updateHUD();for(var i=0;i<3;i++)spawnBgFish();
</script>
</body>
</html>
