<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ£ å¤§æ¼ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Permanent+Marker&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--ocean-deep:#0a1628;--gold:#ffd700;--gold-dark:#b8960f;--danger:#ff4444;--success:#44ff88}
body{font-family:'Noto Sans JP',sans-serif;background:var(--ocean-deep);color:#fff;overflow:hidden;height:100vh;width:100vw;user-select:none}
#game-container{position:relative;width:100%;height:100%;overflow:hidden}
#sky{position:absolute;top:0;left:0;right:0;height:30%;background:linear-gradient(180deg,#0b1a3a 0%,#1a3a6a 40%,#2a5a9a 70%,#ff8844 90%,#ffaa44 100%)}
#sun{position:absolute;bottom:5%;left:20%;width:60px;height:60px;background:radial-gradient(circle,#ffee88,#ffaa22);border-radius:50%;box-shadow:0 0 40px #ffaa44,0 0 80px #ff884488;animation:sunPulse 4s ease-in-out infinite}
@keyframes sunPulse{0%,100%{box-shadow:0 0 40px #ffaa44,0 0 80px #ff884488}50%{box-shadow:0 0 60px #ffcc44,0 0 100px #ffaa4488}}
#water{position:absolute;top:30%;left:0;right:0;bottom:0;background:linear-gradient(180deg,#1a4a7a 0%,#0d2847 30%,#0a1628 100%)}
.wave{position:absolute;top:-8px;width:200%;height:20px;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 20'%3E%3Cpath d='M0,10 Q150,0 300,10 Q450,20 600,10 Q750,0 900,10 Q1050,20 1200,10' fill='none' stroke='rgba(255,255,255,0.15)' stroke-width='2'/%3E%3C/svg%3E") repeat-x;animation:waveMove 4s linear infinite}
.wave:nth-child(2){top:-4px;animation-duration:5s;opacity:.5}
@keyframes waveMove{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.1);animation:bubbleRise linear infinite}
@keyframes bubbleRise{0%{transform:translateY(0) scale(1);opacity:.6}100%{transform:translateY(-200px) scale(.3);opacity:0}}
#line-canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:9;pointer-events:none}
#hud{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:flex-start;z-index:100;pointer-events:none}
#hud>*{pointer-events:auto}
.hud-panel{background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 16px}
#money-display{font-family:'Permanent Marker',cursive;font-size:1.5rem;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.5)}
#rod-info{font-size:.85rem;opacity:.8;margin-top:4px}
#collection-info{font-size:.8rem;opacity:.6;margin-top:4px}
#cast-count{font-size:.75rem;opacity:.4;margin-top:2px}
#shop-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a;border:none;border-radius:12px;padding:10px 20px;font-family:'Noto Sans JP',sans-serif;font-weight:900;font-size:1rem;cursor:pointer;transition:all .2s;box-shadow:0 4px 15px rgba(255,215,0,.3)}
#shop-btn:hover{transform:scale(1.05)}
.hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
/* ç«¿ã®å…ˆï¼ˆå›ºå®šä½ç½®ï¼‰ */
#rod-tip{position:absolute;top:20%;left:52%;width:6px;height:6px;z-index:10;pointer-events:none}
#fishing-line{position:absolute;top:28%;left:50%;width:2px;height:0;background:linear-gradient(180deg,#ccc,#888);transform-origin:top center;z-index:10;transition:height .5s ease;display:none}
#hook{position:absolute;bottom:-10px;left:-5px;width:12px;height:12px;border:2px solid #aaa;border-top:none;border-left:none;border-radius:0 0 8px 0;transform:rotate(45deg)}
#bait{position:absolute;bottom:-18px;left:-4px;font-size:10px}
#cast-area{position:absolute;bottom:0;left:0;right:0;height:50%;display:flex;align-items:center;justify-content:center;z-index:50;cursor:pointer}
#cast-btn{font-family:'Permanent Marker',cursive;font-size:2rem;color:#fff;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50%;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;animation:castPulse 2s ease-in-out infinite}
#cast-btn:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
@keyframes castPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.2)}50%{box-shadow:0 0 0 20px rgba(255,255,255,0)}}
#approaching-fish{position:absolute;z-index:12;display:none;filter:drop-shadow(0 0 8px rgba(255,255,255,.3));pointer-events:none}
#bite-scene{position:absolute;z-index:15;display:none;text-align:center;pointer-events:none}
#bite-scene .bite-fish{animation:biteChomp .25s ease-in-out infinite alternate}
#bite-scene .bite-label{background:rgba(0,0,0,.75);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:4px 14px;font-size:.9rem;font-weight:700;white-space:nowrap;margin-top:6px;display:inline-block}
#bite-scene .bite-size{font-size:.75rem;opacity:.6;margin-top:2px}
#bite-scene .bite-rarity{font-size:.7rem;margin-top:2px;padding:2px 8px;border-radius:10px;display:inline-block}
@keyframes biteChomp{0%{transform:rotate(-10deg) scale(1)}100%{transform:rotate(10deg) scale(1.15)}}
.splash{position:absolute;width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.5);animation:splashExpand .6s ease-out forwards;pointer-events:none;z-index:14}
@keyframes splashExpand{0%{transform:translate(-50%,-50%) scale(0);opacity:1}100%{transform:translate(-50%,-50%) scale(3);opacity:0}}
#hit-banner{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:20;font-family:'Permanent Marker',cursive;font-size:3rem;color:var(--danger);text-shadow:0 0 20px var(--danger),0 0 40px rgba(255,0,0,.3);pointer-events:none;transition:transform .2s cubic-bezier(.175,.885,.32,1.275);white-space:nowrap}
#hit-banner.show{transform:translate(-50%,-50%) scale(1)}
#fighting-fish{position:absolute;z-index:11;display:none;pointer-events:none;filter:drop-shadow(0 0 12px rgba(255,255,255,.4))}
/* é‡£ã‚Šä¸Šã’æ¼”å‡ºç”¨ */
#catch-anim-fish{position:absolute;z-index:200;pointer-events:none;display:none;transition:none}
#fight-ui{position:absolute;bottom:14%;left:50%;transform:translateX(-50%);text-align:center;z-index:60;display:none;width:340px}
#fight-fish-display{font-size:1rem;margin-bottom:4px;font-weight:700}
#distance-display{font-family:'Permanent Marker',cursive;font-size:1.5rem;margin-bottom:6px;text-shadow:0 0 10px rgba(255,255,255,.3)}
#distance-display .dist-num{font-size:2rem;transition:color .2s}
#fight-bar-container{width:100%;height:26px;background:rgba(0,0,0,.5);border-radius:13px;border:2px solid rgba(255,255,255,.2);overflow:hidden;position:relative;margin-bottom:8px}
#fight-bar{height:100%;width:50%;border-radius:11px;transition:width .1s}
#fight-bar-label{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.8);pointer-events:none}
#fight-instruction{font-size:1rem;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.8);animation:fightFlash .5s ease-in-out infinite alternate}
@keyframes fightFlash{0%{opacity:.7}100%{opacity:1}}
#space-hint{margin-top:6px;font-size:.78rem;opacity:.5}
#space-hint kbd{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:4px;padding:2px 8px;font-family:monospace}
.ripple{position:absolute;width:20px;height:6px;border:1px solid rgba(255,255,255,.3);border-radius:50%;animation:rippleOut 1.5s ease-out infinite;pointer-events:none;z-index:11}
@keyframes rippleOut{0%{transform:translate(-50%,-50%) scale(1);opacity:.6}100%{transform:translate(-50%,-50%) scale(4);opacity:0}}
#waiting-text{position:absolute;top:38%;left:50%;transform:translateX(-50%);font-size:.95rem;opacity:.4;z-index:15;display:none}
#catch-popup,#escaped-popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(0,0,0,.88);backdrop-filter:blur(20px);border-radius:20px;padding:30px 40px;text-align:center;z-index:300;transition:transform .4s cubic-bezier(.175,.885,.32,1.275)}
#catch-popup{border:2px solid var(--gold)}#escaped-popup{border:2px solid var(--danger)}
#catch-popup.show,#escaped-popup.show{transform:translate(-50%,-50%) scale(1)}
.fish-emoji{font-size:4rem;margin-bottom:10px}.fish-name{font-family:'Permanent Marker',cursive;font-size:1.8rem;color:var(--gold)}
.fish-size{font-size:1.1rem;margin:6px 0;opacity:.8}.fish-reward{font-size:1.4rem;color:var(--gold);font-weight:900;margin:10px 0}
.rarity-tag{display:inline-block;font-size:.7rem;font-weight:900;padding:2px 10px;border-radius:20px;margin-bottom:6px}
.rarity-common{background:rgba(255,255,255,.15);color:#aaa}.rarity-uncommon{background:rgba(68,255,136,.15);color:var(--success)}.rarity-rare{background:rgba(68,136,255,.2);color:#66aaff}.rarity-epic{background:rgba(180,80,255,.2);color:#bb77ff}
.rarity-legendary{background:rgba(255,215,0,.2);color:var(--gold);animation:legendGlow 1s ease-in-out infinite alternate}
.rarity-mythic{background:rgba(255,50,50,.25);color:#ff4466;animation:mythicGlow .8s ease-in-out infinite alternate}
@keyframes legendGlow{0%{box-shadow:0 0 5px rgba(255,215,0,.3)}100%{box-shadow:0 0 15px rgba(255,215,0,.6)}}
@keyframes mythicGlow{0%{box-shadow:0 0 5px rgba(255,50,80,.3)}100%{box-shadow:0 0 20px rgba(255,50,80,.7)}}
.new-badge{display:inline-block;background:var(--success);color:#1a1a1a;font-size:.75rem;font-weight:900;padding:2px 10px;border-radius:20px;margin-bottom:6px}
.close-btn{background:var(--gold);color:#1a1a1a;border:none;border-radius:10px;padding:8px 30px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;margin-top:10px}
#shop-modal{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:400;display:none;align-items:center;justify-content:center}
#shop-modal.show{display:flex}
#shop-content{background:linear-gradient(135deg,#1a2a4a,#0d1a30);border:2px solid var(--gold);border-radius:20px;padding:30px;width:90%;max-width:500px;max-height:85vh;overflow-y:auto}
#shop-content h2{font-family:'Permanent Marker',cursive;font-size:1.8rem;color:var(--gold);text-align:center;margin-bottom:6px}
#shop-money{text-align:center;color:var(--gold);font-weight:700;margin-bottom:16px;font-size:1.1rem}
.shop-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;transition:all .2s}.shop-item:hover{background:rgba(255,255,255,.1)}.shop-item.owned{border-color:var(--success);background:rgba(68,255,136,.05)}.shop-item.equipped{border-color:var(--gold);background:rgba(255,215,0,.1)}.shop-item-info h3{font-size:1rem;margin-bottom:4px}.shop-item-info p{font-size:.8rem;opacity:.6}.shop-item-info .stats{font-size:.8rem;color:var(--success);margin-top:2px}
.buy-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700;font-size:.85rem;cursor:pointer;white-space:nowrap;font-family:'Noto Sans JP',sans-serif}.buy-btn:disabled{opacity:.4;cursor:not-allowed}.buy-btn.equip-btn{background:linear-gradient(135deg,#44aaff,#2266aa);color:#fff}.buy-btn.equipped-btn{background:rgba(255,215,0,.3);color:var(--gold)}
#shop-close{display:block;margin:16px auto 0;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px 30px;font-size:1rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.swimming-fish{position:absolute;font-size:1.5rem;z-index:5;opacity:.15;pointer-events:none}
.sparkle{position:absolute;width:6px;height:6px;background:var(--gold);border-radius:50%;pointer-events:none;z-index:350;animation:sparkleFade .8s ease-out forwards}
@keyframes sparkleFade{0%{transform:scale(1);opacity:1}100%{transform:scale(0) translate(var(--dx),var(--dy));opacity:0}}
@keyframes lineShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}

/* ===== Menu Screen ===== */
#menu-screen{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);backdrop-filter:blur(15px);z-index:500;display:none;align-items:center;justify-content:center}
.menu-content{text-align:center;max-width:400px;width:90%}
.menu-content h1{font-family:'Permanent Marker',cursive;font-size:2.5rem;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,.5);margin-bottom:30px}
#freeplay-btn{background:linear-gradient(135deg,#44aaff,#2266cc);color:white;border:none;border-radius:12px;padding:14px 40px;font-family:'Noto Sans JP',sans-serif;font-weight:900;font-size:1.2rem;cursor:pointer;width:100%;margin-bottom:20px;transition:all .2s}
#freeplay-btn:hover{transform:scale(1.03)}
.menu-divider{color:rgba(255,255,255,.4);font-size:.85rem;margin:20px 0 15px}
#room-input{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:12px 16px;color:white;font-size:1rem;width:100%;margin-bottom:12px;font-family:'Noto Sans JP',sans-serif;text-align:center;outline:none}
#room-input::placeholder{color:rgba(255,255,255,.3)}
#room-input:focus{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.2)}
.menu-room-btns{display:flex;gap:10px;margin-bottom:12px}
.menu-room-btns button{flex:1;border:none;border-radius:10px;padding:12px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:.95rem;cursor:pointer;transition:all .2s}
#create-room-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a}
#join-room-btn{background:linear-gradient(135deg,var(--success),#22aa55);color:#1a1a1a}
.menu-room-btns button:hover{transform:scale(1.03)}
.menu-room-btns button:disabled{opacity:.5;cursor:not-allowed;transform:none}
#connection-status{color:rgba(255,255,255,.7);font-size:.85rem;min-height:1.5em;margin:8px 0}
#invite-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:white;border-radius:8px;padding:8px 20px;font-family:'Noto Sans JP',sans-serif;font-size:.85rem;cursor:pointer;display:none;transition:all .2s}
#invite-btn:hover{background:rgba(255,255,255,.2)}

/* ===== Battle HUD ===== */
#battle-hud{position:absolute;top:0;left:0;right:0;display:none;justify-content:space-between;align-items:flex-start;padding:8px;z-index:100;pointer-events:none;gap:6px}
#battle-hud>*{pointer-events:auto}
.battle-card{background:rgba(0,0,0,.65);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 14px;flex:1}
#battle-card-me{border-left:3px solid #44aaff;text-align:left}
#battle-card-op{border-right:3px solid #ff6644;text-align:right}
.battle-card-label{font-size:.75rem;opacity:.6;margin-bottom:4px;font-weight:700}
.battle-card-score{font-family:'Permanent Marker',cursive;font-size:1.1rem;color:var(--gold)}
.battle-card-activity{font-size:.8rem;margin-top:4px;min-height:1.2em;opacity:.85}
.battle-card-fish-info{font-size:.75rem;margin-top:3px}
.battle-card-progress{margin-top:4px;display:flex;align-items:center;gap:5px}
#battle-card-op .battle-card-progress{flex-direction:row-reverse}
.bc-progress-bar{flex:1;height:8px;background:rgba(255,255,255,.12);border-radius:4px;overflow:hidden}
.bc-progress-fill{height:100%;border-radius:4px;transition:width .3s,background .3s;width:0%}
.bc-progress-pct{font-size:.65rem;min-width:30px;opacity:.7}
#battle-card-me .bc-progress-pct{text-align:left}
#battle-card-op .bc-progress-pct{text-align:right}
.battle-timer-center{background:rgba(0,0,0,.7);backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.25);border-radius:50%;width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-family:'Permanent Marker',cursive;font-size:1.8rem;transition:color .3s;flex-shrink:0}
.battle-timer-center.timer-low{color:var(--danger);animation:timerPulse .5s ease-in-out infinite alternate}
@keyframes timerPulse{0%{transform:scale(1)}100%{transform:scale(1.15)}}
#opponent-ghost-fish{position:absolute;z-index:8;pointer-events:none;display:none;opacity:.3;font-size:2rem;transition:left .8s ease,top .8s ease}
#opponent-ghost-fish.ghost-catch{animation:ghostCatch .6s ease-out forwards}
#opponent-ghost-fish.ghost-escape{animation:ghostEscape .6s ease-out forwards}
@keyframes ghostCatch{0%{opacity:.3;transform:translateY(0)}100%{opacity:0;transform:translateY(-80px)}}
@keyframes ghostEscape{0%{opacity:.3;transform:translateX(0)}100%{opacity:0;transform:translateX(120px)}}

/* ===== Result Screen ===== */
#result-screen{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);backdrop-filter:blur(15px);z-index:500;display:none;align-items:center;justify-content:center}
.result-content{text-align:center;max-width:450px;width:90%}
#result-title{font-family:'Permanent Marker',cursive;font-size:3rem;margin-bottom:30px}
.result-title-win{color:var(--gold);text-shadow:0 0 30px rgba(255,215,0,.5)}
.result-title-lose{color:var(--danger)}
.result-title-draw,.result-title-disconnect{color:#aaa}
.result-scores{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:30px}
.result-player{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px 24px;min-width:120px}
.result-label{font-size:.85rem;opacity:.6;margin-bottom:8px}
.result-gold{font-family:'Permanent Marker',cursive;font-size:1.8rem;color:var(--gold);margin-bottom:4px}
.result-catches{font-size:1rem;opacity:.8}
.result-vs{font-family:'Permanent Marker',cursive;font-size:1.5rem;opacity:.4}
.result-btns{display:flex;gap:12px;justify-content:center}
.result-btns button{border:none;border-radius:10px;padding:12px 24px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;transition:all .2s}
#rematch-btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#1a1a1a}
#result-menu-btn{background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2)}
.result-btns button:hover{transform:scale(1.05)}
.result-btns button:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* ===== Opponent Toast ===== */
#opponent-toast{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 20px;font-size:.85rem;z-index:150;white-space:nowrap;display:none;pointer-events:none}
@keyframes toastSlide{0%{opacity:0;transform:translateX(-50%) translateY(-10px)}15%{opacity:1;transform:translateX(-50%) translateY(0)}70%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(-10px)}}
</style>
</head>
<body>
<div id="game-container">
  <div id="sky"><div id="sun"></div></div>
  <div id="water"><div class="wave"></div><div class="wave"></div></div>
  <canvas id="line-canvas"></canvas>
  <div id="rod-tip"></div>
  <div id="fishing-line"><div id="hook"></div><div id="bait">ğŸª±</div></div>
  <div id="approaching-fish"></div>
  <div id="bite-scene"><div class="bite-fish"></div><div class="bite-label"></div><div class="bite-size"></div><div class="bite-rarity"></div></div>
  <div id="hit-banner">â€¼ï¸ HIT!</div>
  <div id="fighting-fish"></div>
  <div id="catch-anim-fish"></div>
  <div id="waiting-text">é­šã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
  <div id="hud"><div class="hud-panel"><div id="money-display">ğŸ’° 0G</div><div id="rod-info">ğŸ‹ ç«¹ã®ç«¿</div><div id="collection-info">ğŸ“– 0 / 20ç¨®</div><div id="cast-count">ğŸ£ 0å›ç›®</div></div><div class="hud-right"><button id="shop-btn">ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</button><button id="reset-btn" style="background:rgba(255,50,50,.3);color:#ff8888;border:1px solid rgba(255,50,50,.3);border-radius:10px;padding:8px 14px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:.75rem;cursor:pointer" onclick="resetSave()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button></div></div>
  <div id="cast-area"><div id="cast-btn">ğŸ£<br><span style="font-size:.55rem;font-family:'Noto Sans JP'">ã‚¿ãƒƒãƒ— or SPACE</span></div></div>
  <div id="fight-ui"><div id="fight-fish-display"></div><div id="distance-display">æ®‹ã‚Š <span class="dist-num" id="dist-num">0</span> m</div><div id="fight-bar-container"><div id="fight-bar"></div><div id="fight-bar-label"></div></div><div id="fight-instruction">ğŸ”¥ ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŠ¼ã—ã¦é›¢ã›ï¼</div><div id="space-hint"><kbd>SPACE</kbd> æŠ¼ã—ã¦é›¢ã™ or ã‚¿ãƒƒãƒ—</div></div>
  <div id="catch-popup"><div class="fish-emoji" id="catch-emoji"></div><div id="catch-rarity-tag" class="rarity-tag" style="display:none"></div><div id="catch-new-badge" class="new-badge" style="display:none">NEW!</div><div class="fish-name" id="catch-name"></div><div class="fish-size" id="catch-size"></div><div class="fish-reward" id="catch-reward"></div><button class="close-btn" id="catch-ok-btn" onclick="closeCatchPopup()">OK!</button></div>
  <div id="escaped-popup"><div style="font-size:3rem;margin-bottom:10px">ğŸ’¨</div><div style="font-size:1.3rem;font-weight:700;color:var(--danger)">é€ƒã’ã‚‰ã‚ŒãŸâ€¦ï¼</div><div style="font-size:.9rem;opacity:.6;margin:8px 0" id="escaped-fish-name"></div><button class="close-btn" style="background:var(--danger);color:white" id="escaped-ok-btn" onclick="closeEscapedPopup()">OK</button></div>
  <div id="shop-modal"><div id="shop-content"><h2>ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</h2><div id="shop-money"></div><div id="shop-items"></div><button id="shop-close" onclick="closeShop()">é–‰ã˜ã‚‹</button></div></div>

  <!-- Menu Screen -->
  <div id="menu-screen">
    <div class="menu-content">
      <h1>ğŸ£ å¤§æ¼ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°</h1>
      <button id="freeplay-btn" onclick="startFreePlay()">ğŸ£ ã²ã¨ã‚Šã§éŠã¶</button>
      <div class="menu-divider">--- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æ±º ---</div>
      <input id="room-input" placeholder="ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›" maxlength="20">
      <div class="menu-room-btns">
        <button id="create-room-btn" onclick="createRoom()">ğŸ  ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</button>
        <button id="join-room-btn" onclick="joinRoom()">ğŸšª ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
      </div>
      <div id="connection-status"></div>
      <button id="invite-btn" onclick="copyInviteLink()">ğŸ“‹ æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <!-- Battle HUD -->
  <div id="battle-hud">
    <div id="battle-card-me" class="battle-card">
      <div class="battle-card-label">ã‚ãªãŸ</div>
      <div class="battle-card-score">ğŸ’° <span class="bc-gold">0</span>G  <span class="bc-catches">0</span>åŒ¹</div>
      <div class="battle-card-activity">å¾…æ©Ÿä¸­</div>
      <div class="battle-card-fish-info" style="display:none"><span class="bc-fish-emoji"></span> <span class="bc-fish-name"></span> <span class="bc-fish-size"></span>cm</div>
      <div class="battle-card-progress" style="display:none"><div class="bc-progress-bar"><div class="bc-progress-fill"></div></div><span class="bc-progress-pct">0%</span></div>
    </div>
    <div id="battle-timer" class="battle-timer-center">60</div>
    <div id="battle-card-op" class="battle-card">
      <div class="battle-card-label">ç›¸æ‰‹</div>
      <div class="battle-card-score">ğŸ’° <span class="bc-gold">0</span>G  <span class="bc-catches">0</span>åŒ¹</div>
      <div class="battle-card-activity">å¾…æ©Ÿä¸­</div>
      <div class="battle-card-fish-info" style="display:none"><span class="bc-fish-emoji"></span> <span class="bc-fish-name"></span> <span class="bc-fish-size"></span>cm</div>
      <div class="battle-card-progress" style="display:none"><div class="bc-progress-bar"><div class="bc-progress-fill"></div></div><span class="bc-progress-pct">0%</span></div>
    </div>
  </div>
  <div id="opponent-ghost-fish"></div>

  <!-- Result Screen -->
  <div id="result-screen">
    <div class="result-content">
      <div id="result-title"></div>
      <div class="result-scores">
        <div class="result-player">
          <div class="result-label">ã‚ãªãŸ</div>
          <div class="result-gold" id="result-my-gold">0G</div>
          <div class="result-catches" id="result-my-catches">0åŒ¹</div>
        </div>
        <div class="result-vs">VS</div>
        <div class="result-player">
          <div class="result-label">ç›¸æ‰‹</div>
          <div class="result-gold" id="result-op-gold">0G</div>
          <div class="result-catches" id="result-op-catches">0åŒ¹</div>
        </div>
      </div>
      <div class="result-btns">
        <button id="rematch-btn" onclick="requestRematch()">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
        <button id="result-menu-btn" onclick="backToMenu()">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      </div>
    </div>
  </div>

  <!-- Opponent Toast -->
  <div id="opponent-toast"></div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
const canvas=document.getElementById('line-canvas'),ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
resizeCanvas();window.addEventListener('resize',resizeCanvas);

let money=0,equippedRod='bamboo',ownedRods=['bamboo'],caughtSpecies=new Set(),gameState='idle',totalCasts=0;

// ===== Battle Mode State =====
var gameMode='menu'; // 'menu','freeplay','battle'
var isBattle=false;
var peer=null,conn=null,isHost=false;
var battleTimer=null,battleTimeLeft=60;
var battleScore=0,battleCatches=0;
var opponentScore=0,opponentCatches=0,opponentStatus='';
var opponentFightInfo=null,opponentFightProgress=0,opponentFightActive=false;
var myActivityStatus='å¾…æ©Ÿä¸­',myFightInfo=null,myFightProgress=0;
var ROOM_PREFIX='tairyou-fishing-';
var BATTLE_DURATION=60;

const FISH=[
{id:'sardine',name:'ã‚¤ãƒ¯ã‚·',emoji:'ğŸŸ',minSize:10,maxSize:25,basePrice:8,difficulty:0.22,rarity:0.32,depth:'shallow',color:'#88aacc',tier:'common'},
{id:'horse_mackerel',name:'ã‚¢ã‚¸',emoji:'ğŸŸ',minSize:15,maxSize:35,basePrice:15,difficulty:0.27,rarity:0.28,depth:'shallow',color:'#7799bb',tier:'common'},
{id:'squid',name:'ã‚¤ã‚«',emoji:'ğŸ¦‘',minSize:20,maxSize:50,basePrice:20,difficulty:0.32,rarity:0.22,depth:'shallow',color:'#cc8899',tier:'common'},
{id:'sea_bream',name:'ã‚¿ã‚¤',emoji:'ğŸ¡',minSize:30,maxSize:70,basePrice:50,difficulty:0.48,rarity:0.10,depth:'mid',color:'#ee7788',tier:'uncommon'},
{id:'flounder',name:'ãƒ’ãƒ©ãƒ¡',emoji:'ğŸ ',minSize:35,maxSize:80,basePrice:65,difficulty:0.52,rarity:0.08,depth:'mid',color:'#99bb77',tier:'uncommon'},
{id:'octopus',name:'ã‚¿ã‚³',emoji:'ğŸ™',minSize:30,maxSize:60,basePrice:55,difficulty:0.55,rarity:0.08,depth:'mid',color:'#cc6677',tier:'uncommon'},
{id:'yellowtail',name:'ãƒ–ãƒª',emoji:'ğŸŸ',minSize:50,maxSize:120,basePrice:120,difficulty:0.65,rarity:0.030,depth:'deep',color:'#aabb44',tier:'rare'},
{id:'tuna',name:'ãƒã‚°ãƒ­',emoji:'ğŸŸ',minSize:80,maxSize:200,basePrice:200,difficulty:0.73,rarity:0.020,depth:'deep',color:'#4466aa',tier:'rare'},
{id:'swordfish',name:'ã‚«ã‚¸ã‚­',emoji:'ğŸ—¡ï¸',minSize:100,maxSize:300,basePrice:350,difficulty:0.80,rarity:0.012,depth:'deep',color:'#5577cc',tier:'rare'},
{id:'manta',name:'ãƒãƒ³ã‚¿',emoji:'ğŸ¦…',minSize:200,maxSize:500,basePrice:400,difficulty:0.78,rarity:0.010,depth:'deep',color:'#446688',tier:'rare'},
{id:'shark',name:'ã‚µãƒ¡',emoji:'ğŸ¦ˆ',minSize:150,maxSize:400,basePrice:600,difficulty:0.88,rarity:0.005,depth:'deep',color:'#667788',tier:'epic'},
{id:'whale_shark',name:'ã‚¸ãƒ³ãƒ™ã‚¨ã‚¶ãƒ¡',emoji:'ğŸ‹',minSize:400,maxSize:800,basePrice:1500,difficulty:0.92,rarity:0.003,depth:'deep',color:'#5566aa',tier:'epic'},
{id:'oarfish',name:'ãƒªãƒ¥ã‚¦ã‚°ã‚¦ãƒãƒ„ã‚«ã‚¤',emoji:'ğŸ',minSize:300,maxSize:600,basePrice:2000,difficulty:0.93,rarity:0.0025,depth:'deep',color:'#cc44aa',tier:'epic'},
{id:'giant_squid',name:'ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«',emoji:'ğŸ¦‘',minSize:500,maxSize:1200,basePrice:2500,difficulty:0.95,rarity:0.002,depth:'deep',color:'#883366',tier:'epic'},
{id:'coelacanth',name:'ã‚·ãƒ¼ãƒ©ã‚«ãƒ³ã‚¹',emoji:'ğŸ ',minSize:150,maxSize:200,basePrice:5000,difficulty:0.96,rarity:0.0010,depth:'deep',color:'#3355aa',tier:'legendary'},
{id:'golden_fish',name:'é»„é‡‘ã®é­š',emoji:'âœ¨',minSize:30,maxSize:50,basePrice:8000,difficulty:0.88,rarity:0.0007,depth:'deep',color:'#ffcc00',tier:'legendary'},
{id:'megalodon',name:'ãƒ¡ã‚¬ãƒ­ãƒ‰ãƒ³',emoji:'ğŸ¦ˆ',minSize:1000,maxSize:2000,basePrice:12000,difficulty:0.98,rarity:0.0005,depth:'deep',color:'#554455',tier:'legendary'},
{id:'dragon',name:'é¾é­š',emoji:'ğŸ‰',minSize:500,maxSize:1000,basePrice:20000,difficulty:0.99,rarity:0.00035,depth:'deep',color:'#ff6622',tier:'mythic'},
{id:'leviathan',name:'ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³',emoji:'ğŸŒŠ',minSize:2000,maxSize:5000,basePrice:50000,difficulty:1.0,rarity:0.00015,depth:'deep',color:'#2244aa',tier:'mythic'},
{id:'void_fish',name:'è™šç„¡ã®é­š',emoji:'ğŸ•³ï¸',minSize:1,maxSize:1,basePrice:99999,difficulty:0.95,rarity:0.0001,depth:'deep',color:'#220033',tier:'mythic'},
];
const TIER_INFO={common:{label:'ã‚³ãƒ¢ãƒ³',cls:'rarity-common'},uncommon:{label:'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³',cls:'rarity-uncommon'},rare:{label:'â˜… ãƒ¬ã‚¢',cls:'rarity-rare'},epic:{label:'â˜…â˜… ã‚¨ãƒ”ãƒƒã‚¯',cls:'rarity-epic'},legendary:{label:'â˜…â˜…â˜… ä¼èª¬',cls:'rarity-legendary'},mythic:{label:'âœ¦ ç¥è©±',cls:'rarity-mythic'}};
const RODS=[
{id:'bamboo',name:'ç«¹ã®ç«¿',emoji:'ğŸ‹',price:0,power:1.0,luck:1.0,desc:'åˆå¿ƒè€…ç”¨ã®ç«¿',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜†â˜†â˜†â˜† é‹:â˜…â˜†â˜†â˜†â˜†'},
{id:'fiber',name:'ã‚°ãƒ©ã‚¹ãƒ•ã‚¡ã‚¤ãƒãƒ¼ç«¿',emoji:'ğŸ£',price:200,power:1.4,luck:1.1,desc:'è»½ãã¦ä¸ˆå¤«',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜†â˜†â˜† é‹:â˜…â˜…â˜†â˜†â˜†'},
{id:'carbon',name:'ã‚«ãƒ¼ãƒœãƒ³ç«¿',emoji:'âš¡',price:600,power:1.8,luck:1.3,desc:'ãƒ—ãƒ­ä»•æ§˜',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜†â˜† é‹:â˜…â˜…â˜†â˜†â˜†'},
{id:'titanium',name:'ãƒã‚¿ãƒ³åˆé‡‘ç«¿',emoji:'ğŸ”©',price:1800,power:2.3,luck:1.5,desc:'å¤§ç‰©ã‚‚å¼•ã‘ã‚‹',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜…â˜† é‹:â˜…â˜…â˜…â˜†â˜†'},
{id:'golden_rod',name:'é»„é‡‘ã®ç«¿',emoji:'âœ¨',price:5000,power:2.8,luck:2.0,desc:'ãƒ¬ã‚¢é­šãŒå‡ºã‚„ã™ã„',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜…â˜† é‹:â˜…â˜…â˜…â˜…â˜…'},
{id:'mithril',name:'ãƒŸã‚¹ãƒªãƒ«ãƒ­ãƒƒãƒ‰',emoji:'ğŸ’',price:15000,power:3.5,luck:2.8,desc:'å¤ä»£ã®é‡‘å±',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜…â˜… é‹:â˜…â˜…â˜…â˜…â˜†'},
{id:'abyssal',name:'æ·±æ·µã®ç«¿',emoji:'ğŸŒ€',price:40000,power:4.2,luck:3.5,desc:'æ·±æµ·ã®é­”åŠ›',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜…â˜…+ é‹:â˜…â˜…â˜…â˜…â˜…'},
{id:'divine',name:'ç¥ç«¿ã€Œæµ·ç¥ã€',emoji:'ğŸ”±',price:100000,power:5.5,luck:5.0,desc:'ç¥è©±ã™ã‚‰é‡£ã‚‹',stats:'ãƒ‘ãƒ¯ãƒ¼:â˜…â˜…â˜…â˜…â˜…++ é‹:â˜…â˜…â˜…â˜…â˜…++'},
];

function getRod(){return RODS.find(r=>r.id===equippedRod)}
function pickFish(){const rod=getRod();let pool=FISH.map(f=>{let w=f.rarity;if(f.tier==='rare')w*=rod.luck;if(f.tier==='epic')w*=Math.pow(rod.luck,1.5);if(f.tier==='legendary')w*=Math.pow(rod.luck,2);if(f.tier==='mythic')w*=Math.pow(rod.luck,2.5);if(f.depth==='deep'&&rod.power<1.5)w*=0.25;return{...f,weight:w}});const t=pool.reduce((s,f)=>s+f.weight,0);let r=Math.random()*t;for(const f of pool){r-=f.weight;if(r<=0)return f}return pool[0]}
function randomSize(f){return Math.round(f.minSize+(f.maxSize-f.minSize)*Math.pow(Math.random(),1.5))}
function calcReward(f,s){return Math.round(f.basePrice*(s/f.minSize)*(0.8+Math.random()*0.4))}
function getFishScale(f,s){return 1.5+Math.min(((s-f.minSize)/Math.max(1,f.maxSize-f.minSize))*2.5,3)}
function calcStartDistance(f,s){return Math.round((7+f.difficulty*35+(s/f.maxSize)*8)*10)/10}
function updateHUD(){document.getElementById('money-display').textContent='ğŸ’° '+money.toLocaleString()+'G';const rod=getRod();document.getElementById('rod-info').textContent=rod.emoji+' '+rod.name;document.getElementById('collection-info').textContent='ğŸ“– '+caughtSpecies.size+' / '+FISH.length+'ç¨®';document.getElementById('cast-count').textContent='ğŸ£ '+totalCasts+'å›ç›®'}

// BG
function spawnBgFish(){const w=document.getElementById('water'),f=FISH[Math.floor(Math.random()*6)];const el=document.createElement('div');el.className='swimming-fish';el.textContent=f.emoji;el.style.top=(20+Math.random()*60)+'%';el.style.fontSize=(1+Math.random())+'rem';el.style.opacity=.12+Math.random()*.12;const dur=(8+Math.random()*12)*1000;const goR=Math.random()>.5;if(goR){el.style.left='-40px';el.style.transform='scaleX(1)';el.animate([{left:'-40px'},{left:'calc(100% + 40px)'}],{duration:dur,fill:'forwards'}).onfinish=function(){el.remove()}}else{el.style.left='calc(100% + 40px)';el.style.transform='scaleX(-1)';el.animate([{left:'calc(100% + 40px)'},{left:'-40px'}],{duration:dur,fill:'forwards'}).onfinish=function(){el.remove()}}w.appendChild(el)}
setInterval(spawnBgFish,3000);
setInterval(function(){const w=document.getElementById('water'),b=document.createElement('div');b.className='bubble';const s=4+Math.random()*8;b.style.width=s+'px';b.style.height=s+'px';b.style.left=Math.random()*100+'%';b.style.top=(30+Math.random()*60)+'%';b.style.animationDuration=(2+Math.random()*4)+'s';w.appendChild(b);b.addEventListener('animationend',function(){b.remove()})},800);

// ===== GAME =====
let currentFish=null,currentSize=0,fightInterval=null,approachAnim=null;
let spaceDown=false,fishDistance=0,maxDistance=0,startDistance=0;
let fishScreenX=0,fishScreenY=0,lineMode='none',lineShake=0; // lineMode: none, waiting, fighting, catching

// ç«¿å…ˆã®åº§æ¨™ã‚’å–å¾—
function getRodTipPos(){
  var rt=document.getElementById('rod-tip').getBoundingClientRect();
  return{x:rt.left+rt.width/2, y:rt.top+rt.height/2};
}

document.addEventListener('keydown',function(e){if(e.code==='Space'||e.code==='Enter'){e.preventDefault();if(e.code==='Space')spaceDown=true}});
document.addEventListener('keyup',function(e){if(e.code==='Space'){e.preventDefault();if(!spaceDown)return;spaceDown=false;if(document.getElementById('catch-popup').classList.contains('show')){closeCatchPopup();return}if(document.getElementById('escaped-popup').classList.contains('show')){closeEscapedPopup();return}handleAction()}if(e.code==='Enter'){if(document.getElementById('catch-popup').classList.contains('show')){closeCatchPopup();return}if(document.getElementById('escaped-popup').classList.contains('show')){closeEscapedPopup();return}handleAction()}});
document.getElementById('cast-area').addEventListener('click',handleAction);

function handleAction(){
  if(gameMode==='menu')return;
  if(document.getElementById('result-screen').style.display==='flex')return;
  if(document.getElementById('shop-modal').classList.contains('show'))return;
  if(document.getElementById('catch-popup').classList.contains('show'))return;
  if(document.getElementById('escaped-popup').classList.contains('show'))return;
  if(gameState==='idle')startCasting();else if(gameState==='bite')startFight();else if(gameState==='fighting')reel()
}
function getHookPos(){var r=document.getElementById('fishing-line').getBoundingClientRect();return{x:r.left+r.width/2,y:r.bottom}}

function startCasting(){
  gameState='casting';totalCasts++;updateHUD();document.getElementById('cast-btn').style.display='none';
  if(isBattle){myActivityStatus='ã‚­ãƒ£ã‚¹ãƒˆä¸­...';myFightInfo=null;myFightProgress=0;updateBattleHUD();if(conn&&conn.open)conn.send({type:'status',statusText:'ã‚­ãƒ£ã‚¹ãƒˆä¸­...'})}
  var fl=document.getElementById('fishing-line');fl.style.display='block';fl.style.height='0px';fl.style.animation='none';lineMode='none';
  setTimeout(function(){fl.style.height='38%';gameState='waiting';document.getElementById('waiting-text').style.display='block';lineMode='waiting';
    setTimeout(function(){var hp=getHookPos();fishScreenX=hp.x;fishScreenY=hp.y;var r=document.createElement('div');r.className='ripple';r.style.left=hp.x+'px';r.style.top=hp.y+'px';document.getElementById('game-container').appendChild(r);setTimeout(function(){r.remove()},3000)},600);
    setTimeout(function(){if(gameState==='waiting'){currentFish=pickFish();currentSize=randomSize(currentFish);startApproach()}},1200+Math.random()*2500);
  },100);
}

function startApproach(){
  if(gameState!=='waiting')return;var hp=getHookPos(),scale=getFishScale(currentFish,currentSize),fromL=Math.random()>.5;
  var af=document.getElementById('approaching-fish');af.textContent=currentFish.emoji;af.style.fontSize=scale+'rem';af.style.display='block';af.style.top=(hp.y-10)+'px';
  var sx=fromL?-80:window.innerWidth+80,ex=hp.x-20;af.style.left=sx+'px';af.style.transform=fromL?'scaleX(1)':'scaleX(-1)';
  var dur=1000+Math.random()*800;var st=null;
  function anim(ts){if(!st)st=ts;var el=ts-st,p=Math.min(el/dur,1);var e=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;af.style.left=(sx+(ex-sx)*e)+'px';af.style.top=(hp.y-10+Math.sin(el/120)*4)+'px';if(p<1&&gameState==='waiting')approachAnim=requestAnimationFrame(anim);else if(p>=1)triggerBite()}
  approachAnim=requestAnimationFrame(anim);
}

function triggerBite(){
  gameState='bite';document.getElementById('approaching-fish').style.display='none';document.getElementById('waiting-text').style.display='none';
  if(isBattle){myActivityStatus=currentFish.name+' ãŒHIT!';myFightInfo={emoji:currentFish.emoji,name:currentFish.name,tier:currentFish.tier,size:currentSize};updateBattleHUD();if(conn&&conn.open)conn.send({type:'status',statusText:currentFish.name+' ãŒHIT!'})}
  var hp=getHookPos(),scale=getFishScale(currentFish,currentSize),bs=document.getElementById('bite-scene');
  bs.querySelector('.bite-fish').textContent=currentFish.emoji;bs.querySelector('.bite-fish').style.fontSize=scale+'rem';
  bs.querySelector('.bite-label').textContent=currentFish.name+'ãŒé£Ÿã„ã¤ã„ãŸï¼';bs.querySelector('.bite-size').textContent='æ¨å®š '+currentSize+'cm';
  var ti=TIER_INFO[currentFish.tier],br=bs.querySelector('.bite-rarity');br.textContent=ti.label;br.className='bite-rarity '+ti.cls;
  bs.style.left=hp.x+'px';bs.style.top=(hp.y-10)+'px';bs.style.display='block';document.getElementById('hit-banner').classList.add('show');
  for(var i=0;i<3;i++){(function(i){setTimeout(function(){var s=document.createElement('div');s.className='splash';s.style.left=(hp.x+(Math.random()-.5)*40)+'px';s.style.top=(hp.y+(Math.random()-.5)*20)+'px';document.getElementById('game-container').appendChild(s);setTimeout(function(){s.remove()},600)},i*150)})(i)}
  if(navigator.vibrate)navigator.vibrate([100,50,100,50,200]);
  document.getElementById('fishing-line').style.animation='lineShake .1s ease-in-out 15';
  setTimeout(function(){if(gameState==='bite')fishEscaped()},2500);
}

function startFight(){
  gameState='fighting';document.getElementById('bite-scene').style.display='none';document.getElementById('hit-banner').classList.remove('show');
  // é™çš„ãªé‡£ã‚Šç³¸ã‚’æ¶ˆã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ã«
  document.getElementById('fishing-line').style.display='none';document.getElementById('fishing-line').style.animation='none';
  lineMode='fighting';
  document.getElementById('fight-ui').style.display='block';
  var scale=getFishScale(currentFish,currentSize),ti=TIER_INFO[currentFish.tier];
  document.getElementById('fight-fish-display').innerHTML='<span style="font-size:'+Math.min(scale*.6,2)+'rem">'+currentFish.emoji+'</span> '+currentFish.name+' '+currentSize+'cm <span class="rarity-tag '+ti.cls+'" style="font-size:.65rem">'+ti.label+'</span>';
  var ff=document.getElementById('fighting-fish');ff.textContent=currentFish.emoji;ff.style.fontSize=scale+'rem';ff.style.display='block';
  startDistance=calcStartDistance(currentFish,currentSize);fishDistance=startDistance;maxDistance=startDistance*1.7;
  updateDistanceUI();
  var rod=getRod();var eff=(currentFish.difficulty*(0.65+0.35*currentSize/currentFish.maxSize))/(rod.power*0.45);
  var pullRate=0.025+eff*0.09;var jerkChance=eff*0.04;var jerkPower=0.6+eff*1.2;
  var tick=0;
  fightInterval=setInterval(function(){tick++;fishDistance+=pullRate;
    if(Math.random()<jerkChance){fishDistance+=jerkPower*(0.5+Math.random());lineShake=10}
    if(lineShake>0)lineShake-=0.5;
    var dr=Math.min(fishDistance/maxDistance,1);
    // é­šã®ç”»é¢åº§æ¨™ï¼ˆæ°´é¢ä»˜è¿‘ï½ç”»é¢å³ä¸‹æ–¹å‘ã¸ï¼‰
    var waterTop=window.innerHeight*0.30;
    var fx=window.innerWidth*0.50+dr*window.innerWidth*0.35;
    var fy=waterTop+20+dr*window.innerHeight*0.25+Math.sin(tick*.07)*10;
    ff.style.left=fx+'px';ff.style.top=fy+'px';
    ff.style.transform='scale('+Math.max(.4,1-dr*.5)+')';
    fishScreenX=fx;fishScreenY=fy;
    if(isBattle&&tick%10===0){myFightProgress=Math.max(0,Math.min(1,1-fishDistance/maxDistance));updateBattleHUD();if(conn&&conn.open)conn.send({type:'fight-update',progress:myFightProgress})}
    if(fishDistance>=maxDistance)fishEscaped();updateDistanceUI();
  },50);
  if(isBattle){myActivityStatus='æ ¼é—˜ä¸­';myFightInfo={emoji:currentFish.emoji,name:currentFish.name,tier:currentFish.tier,size:currentSize};myFightProgress=Math.max(0,Math.min(1,1-fishDistance/maxDistance));updateBattleHUD();if(conn&&conn.open)conn.send({type:'fight-start',emoji:currentFish.emoji,name:currentFish.name,tier:currentFish.tier,size:currentSize})}
}

// ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ãƒ«ãƒ¼ãƒ—ï¼šç«¿å…ˆâ†’é­šã‚’ã¤ãªãç³¸
function drawLineLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(lineMode==='fighting'||lineMode==='catching'){
    var tip=getRodTipPos();
    var fx=fishScreenX,fy=fishScreenY;
    var dx=fx-tip.x,dy=fy-tip.y;
    var dist=Math.sqrt(dx*dx+dy*dy);

    // ãŸã‚‹ã¿ï¼ˆè·é›¢ãŒé ã„ã»ã©ãŸã‚‹ã‚€ã€è¿‘ã„ã¨ãƒ”ãƒ³å¼µã‚Šï¼‰
    var tensionRatio=lineMode==='catching'?1:Math.max(0,1-fishDistance/maxDistance);
    var sag=(1-tensionRatio)*Math.min(dist*0.2,80);

    // ã‚¸ãƒ£ãƒ¼ã‚¯æºã‚Œ
    var sx=lineShake>0?(Math.random()-.5)*lineShake*3:0;

    // è‰²ï¼šè¿‘ã„=ç™½ã£ã½ã„ã€é ã„=èµ¤ã£ã½ã„
    var r,g,b,alpha=0.95;
    if(lineMode==='catching'){r=200;g=255;b=200}
    else if(tensionRatio>0.6){r=220;g=240;b=220}
    else if(tensionRatio>0.3){r=240;g=200;b=100}
    else{r=255;g=100;b=80}

    // ç·šã®å¤ªã•ï¼šãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã„=å¤ªã„
    ctx.lineWidth=lineMode==='catching'?3.5:2+tensionRatio*2;
    ctx.strokeStyle='rgba('+r+','+g+','+b+','+alpha+')';
    ctx.shadowColor='rgba('+r+','+g+','+b+',0.5)';
    ctx.shadowBlur=lineMode==='catching'?12:4+tensionRatio*6;
    ctx.lineCap='round';

    // 2æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šï¼ˆä¸­é–“ç‚¹ã‚’ãŸã‚‹ã¾ã›ã‚‹ï¼‰
    var mx=(tip.x+fx)/2+sx;
    var my=(tip.y+fy)/2+sag;

    ctx.beginPath();
    ctx.moveTo(tip.x,tip.y);
    ctx.quadraticCurveTo(mx,my,fx+sx*0.5,fy);
    ctx.stroke();
    ctx.shadowBlur=0;

    // ãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã„æ™‚ã«ç³¸ã«å…‰ã‚‹ç‚¹
    if(tensionRatio>0.5){
      var t=Date.now()/400%1;
      var px=tip.x*(1-t)*(1-t)+mx*2*(1-t)*t+fx*t*t;
      var py=tip.y*(1-t)*(1-t)+my*2*(1-t)*t+fy*t*t;
      ctx.fillStyle='rgba(255,255,255,'+(0.3+tensionRatio*0.4)+')';
      ctx.beginPath();ctx.arc(px,py,2,0,Math.PI*2);ctx.fill();
    }
  }
  requestAnimationFrame(drawLineLoop);
}
requestAnimationFrame(drawLineLoop);

function reel(){
  if(gameState!=='fighting')return;var rod=getRod();
  var pp=0.4+rod.power*0.4;fishDistance-=pp;lineShake=3;
  if(fishDistance<=0){fishDistance=0;updateDistanceUI();catchFish();return}
  updateDistanceUI();
}

function updateDistanceUI(){var dn=document.getElementById('dist-num'),dist=Math.max(0,fishDistance);dn.textContent=dist.toFixed(1);var pct=Math.max(0,Math.min(100,(1-dist/maxDistance)*100));var fb=document.getElementById('fight-bar');fb.style.width=pct+'%';if(pct>70)fb.style.background='linear-gradient(90deg,#44cc88,var(--success))';else if(pct>40)fb.style.background='linear-gradient(90deg,var(--gold),#aacc44)';else fb.style.background='linear-gradient(90deg,var(--danger),#cc8844)';document.getElementById('fight-bar-label').textContent='æ®‹ã‚Š '+dist.toFixed(1)+'m';var inst=document.getElementById('fight-instruction');if(dist<2){inst.textContent='ğŸ”¥ ã‚ã¨å°‘ã—ï¼';inst.style.color='var(--success)'}else if(dist>startDistance*1.3){inst.textContent='âš ï¸ é›¢ã•ã‚Œã¦ã‚‹ï¼';inst.style.color='var(--danger)'}else{inst.textContent='ğŸ”¥ ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŠ¼ã—ã¦é›¢ã›ï¼';inst.style.color='white'}dn.style.color=dist<2?'var(--success)':dist>startDistance*1.3?'var(--danger)':'var(--gold)'}

// é‡£ã‚Šä¸Šã’æ¼”å‡ºï¼šé­šãŒç³¸ã«å¼•ã‹ã‚Œã¦æ°´é¢ã‹ã‚‰é£›ã³å‡ºã™
function catchFish(){
  clearInterval(fightInterval);gameState='idle';
  document.getElementById('fight-ui').style.display='none';
  var ff=document.getElementById('fighting-fish');ff.style.display='none';

  // é‡£ã‚Šä¸Šã’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  lineMode='catching';
  var caf=document.getElementById('catch-anim-fish');
  caf.textContent=currentFish.emoji;
  var scale=getFishScale(currentFish,currentSize);
  caf.style.fontSize=scale+'rem';caf.style.display='block';
  var waterTop=window.innerHeight*0.30;
  // é–‹å§‹ä½ç½®ï¼šæ°´é¢ä»˜è¿‘ã®ä¸­å¤®
  var startX=window.innerWidth*0.5,startY=waterTop+20;
  // çµ‚äº†ä½ç½®ï¼šç«¿å…ˆã®å°‘ã—ä¸‹
  var tip=getRodTipPos();
  var endX=tip.x,endY=tip.y+30;
  fishScreenX=startX;fishScreenY=startY;

  var dur=600;var st=null;
  function anim(ts){
    if(!st)st=ts;var el=ts-st,p=Math.min(el/dur,1);
    // ã‚¤ãƒ¼ã‚ºã‚¢ã‚¦ãƒˆã§é£›ã³ä¸ŠãŒã‚‹
    var ep=1-Math.pow(1-p,3);
    var cx=startX+(endX-startX)*ep;
    // Yæ–¹å‘ã¯å¼§ã‚’æã„ã¦ä¸ŠãŒã‚‹
    var arcY=-80*Math.sin(p*Math.PI);
    var cy=startY+(endY-startY)*ep+arcY;
    caf.style.left=cx+'px';caf.style.top=cy+'px';
    caf.style.transform='scale('+(1+0.3*Math.sin(p*Math.PI))+') rotate('+(-30*p)+'deg)';
    fishScreenX=cx;fishScreenY=cy;

    // æ°´ã—ã¶ãï¼ˆé–‹å§‹æ™‚ï¼‰
    if(el<100&&el>0&&Math.random()<0.3){
      var sp=document.createElement('div');sp.className='splash';
      sp.style.left=(startX+(Math.random()-.5)*60)+'px';sp.style.top=waterTop+'px';
      document.getElementById('game-container').appendChild(sp);setTimeout(function(){sp.remove()},600);
    }

    if(p<1){requestAnimationFrame(anim)}
    else{
      caf.style.display='none';lineMode='none';
      showCatchPopup();
    }
  }
  requestAnimationFrame(anim);
}

function showCatchPopup(){
  var isNew=!caughtSpecies.has(currentFish.id);
  var reward=calcReward(currentFish,currentSize);

  if(isBattle){
    // Battle mode: track battle score, don't add to money
    battleScore+=reward;
    battleCatches++;
    myActivityStatus='é‡£ã‚Šä¸Šã’ãŸ!';myFightInfo=null;myFightProgress=0;
    updateBattleHUD();
    if(conn&&conn.open)conn.send({type:'catch',species:currentFish.emoji+' '+currentFish.name,size:currentSize,reward:reward,totalScore:battleScore,totalCatches:battleCatches});
  }else{
    money+=reward;
    caughtSpecies.add(currentFish.id);
    updateHUD();
  }

  document.getElementById('catch-emoji').textContent=currentFish.emoji;
  document.getElementById('catch-name').textContent=currentFish.name;
  document.getElementById('catch-size').textContent=currentSize+'cm';
  document.getElementById('catch-reward').textContent='+'+reward.toLocaleString()+'G';
  document.getElementById('catch-new-badge').style.display=(!isBattle&&isNew)?'inline-block':'none';
  var ti=TIER_INFO[currentFish.tier],rt=document.getElementById('catch-rarity-tag');rt.textContent=ti.label;rt.className='rarity-tag '+ti.cls;rt.style.display='inline-block';
  document.getElementById('catch-popup').classList.add('show');
  // Hide OK button in battle (auto-close)
  document.getElementById('catch-ok-btn').style.display=isBattle?'none':'';
  var sc=currentFish.tier==='mythic'?40:currentFish.tier==='legendary'?30:currentFish.tier==='epic'?20:12;
  for(var i=0;i<sc;i++){var s=document.createElement('div');s.className='sparkle';var a=(i/sc)*Math.PI*2,d=60+Math.random()*50;s.style.left='calc(50% + '+Math.cos(a)*d+'px)';s.style.top='calc(50% + '+Math.sin(a)*d+'px)';s.style.setProperty('--dx',Math.cos(a)*40+'px');s.style.setProperty('--dy',Math.sin(a)*40+'px');s.style.background=currentFish.color||'var(--gold)';document.getElementById('game-container').appendChild(s);setTimeout(function(el){return function(){el.remove()}}(s),1000)}

  // Auto-close in battle mode
  if(isBattle){setTimeout(function(){closeCatchPopup()},1500)}
}

function fishEscaped(){
  clearInterval(fightInterval);if(approachAnim)cancelAnimationFrame(approachAnim);gameState='idle';lineMode='none';
  ['fight-ui','fishing-line','approaching-fish','bite-scene','waiting-text','fighting-fish','catch-anim-fish'].forEach(function(id){var e=document.getElementById(id);e.style.display='none';if(id==='fishing-line')e.style.animation='none'});
  document.getElementById('hit-banner').classList.remove('show');
  document.getElementById('escaped-fish-name').textContent=currentFish?currentFish.emoji+' '+currentFish.name+' ('+currentSize+'cm) ãŒé€ƒã’ãŸ':'';
  document.getElementById('escaped-popup').classList.add('show');
  // Hide OK button in battle (auto-close)
  document.getElementById('escaped-ok-btn').style.display=isBattle?'none':'';
  resetCastBtn();
  if(isBattle){myActivityStatus='é€ƒã’ã‚‰ã‚ŒãŸ...';myFightInfo=null;myFightProgress=0;updateBattleHUD();if(conn&&conn.open){conn.send({type:'escape',emoji:currentFish?currentFish.emoji:'',name:currentFish?currentFish.name:''});conn.send({type:'status',statusText:'å¾…æ©Ÿä¸­'})}}
  // Auto-close in battle mode
  if(isBattle){setTimeout(function(){closeEscapedPopup()},1500)}
}

function closeCatchPopup(){
  document.getElementById('catch-popup').classList.remove('show');
  document.getElementById('catch-ok-btn').style.display='';
  resetCastBtn();
  if(isBattle){myActivityStatus='å¾…æ©Ÿä¸­';myFightInfo=null;myFightProgress=0;updateBattleHUD();if(conn&&conn.open)conn.send({type:'status',statusText:'å¾…æ©Ÿä¸­'})}
}
function closeEscapedPopup(){
  document.getElementById('escaped-popup').classList.remove('show');
  document.getElementById('escaped-ok-btn').style.display='';
  resetCastBtn();
  if(isBattle){myActivityStatus='å¾…æ©Ÿä¸­';updateBattleHUD();if(conn&&conn.open)conn.send({type:'status',statusText:'å¾…æ©Ÿä¸­'})}
}
function resetCastBtn(){document.getElementById('cast-btn').style.display='flex'}

document.getElementById('shop-btn').addEventListener('click',openShop);
function openShop(){
  if(isBattle)return;
  var si=document.getElementById('shop-items');si.innerHTML='';document.getElementById('shop-money').textContent='æ‰€æŒé‡‘: '+money.toLocaleString()+'G';RODS.forEach(function(rod){var owned=ownedRods.includes(rod.id),equipped=equippedRod===rod.id,canBuy=money>=rod.price&&!owned;var div=document.createElement('div');div.className='shop-item'+(equipped?' equipped':owned?' owned':'');var btn;if(equipped)btn='<button class="buy-btn equipped-btn" disabled>è£…å‚™ä¸­</button>';else if(owned)btn='<button class="buy-btn equip-btn" onclick="equipRod(\''+rod.id+'\')">è£…å‚™</button>';else if(rod.price===0)btn='';else btn='<button class="buy-btn" '+(canBuy?'':'disabled')+' onclick="buyRod(\''+rod.id+'\')">'+rod.price.toLocaleString()+'G</button>';div.innerHTML='<div class="shop-item-info"><h3>'+rod.emoji+' '+rod.name+'</h3><p>'+rod.desc+'</p><div class="stats">'+rod.stats+'</div></div>'+btn;si.appendChild(div)});document.getElementById('shop-modal').classList.add('show')
}
function buyRod(id){var rod=RODS.find(function(r){return r.id===id});if(money>=rod.price&&!ownedRods.includes(id)){money-=rod.price;ownedRods.push(id);equippedRod=id;updateHUD();openShop()}}
function equipRod(id){if(ownedRods.includes(id)){equippedRod=id;updateHUD();openShop()}}
function closeShop(){document.getElementById('shop-modal').classList.remove('show')}

// ===== SAVE / LOAD =====
function saveGame(){
  var data={money:money,equippedRod:equippedRod,ownedRods:ownedRods,caughtSpecies:Array.from(caughtSpecies),totalCasts:totalCasts,ver:2};
  try{localStorage.setItem('fishing_save',JSON.stringify(data))}catch(e){}
}
function loadGame(){
  try{
    var raw=localStorage.getItem('fishing_save');
    if(!raw)return;
    var d=JSON.parse(raw);
    if(d.money!=null)money=d.money;
    if(d.equippedRod)equippedRod=d.equippedRod;
    if(d.ownedRods)ownedRods=d.ownedRods;
    if(d.caughtSpecies)caughtSpecies=new Set(d.caughtSpecies);
    if(d.totalCasts!=null)totalCasts=d.totalCasts;
  }catch(e){}
}
function resetSave(){
  if(confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
    localStorage.removeItem('fishing_save');
    money=0;equippedRod='bamboo';ownedRods=['bamboo'];caughtSpecies=new Set();totalCasts=0;
    updateHUD();
  }
}

// é‡£ã‚Šä¸Šã’ãƒ»è³¼å…¥æ™‚ã«ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
var _origShowCatch=showCatchPopup;
showCatchPopup=function(){_origShowCatch();if(!isBattle)saveGame()};
var _origBuyRod=buyRod;
buyRod=function(id){_origBuyRod(id);saveGame()};
var _origEquipRod=equipRod;
equipRod=function(id){_origEquipRod(id);saveGame()};

// ===== MENU SCREEN =====
function showMenuScreen(){
  gameMode='menu';
  isBattle=false;
  document.getElementById('menu-screen').style.display='flex';
  document.getElementById('battle-hud').style.display='none';
  document.getElementById('result-screen').style.display='none';
  document.getElementById('cast-area').style.display='none';
  document.getElementById('hud').style.display='none';
  document.getElementById('connection-status').textContent='';
  document.getElementById('invite-btn').style.display='none';
  document.getElementById('create-room-btn').disabled=false;
  document.getElementById('join-room-btn').disabled=false;
  // Check URL params for auto-join
  var params=new URLSearchParams(window.location.search);
  var room=params.get('room');
  if(room){
    document.getElementById('room-input').value=room;
    window.history.replaceState({},'',window.location.pathname);
    setTimeout(function(){joinRoom()},500);
  }
}

function startFreePlay(){
  gameMode='freeplay';
  isBattle=false;
  document.getElementById('menu-screen').style.display='none';
  document.getElementById('hud').style.display='flex';
  document.getElementById('cast-area').style.display='flex';
  document.getElementById('shop-btn').style.display='';
  document.getElementById('reset-btn').style.display='';
  document.getElementById('cast-btn').style.display='flex';
  gameState='idle';
}

function startBattle(){
  gameMode='battle';
  isBattle=true;
  document.getElementById('menu-screen').style.display='none';
  document.getElementById('result-screen').style.display='none';
  document.getElementById('hud').style.display='none';
  document.getElementById('cast-area').style.display='flex';
  document.getElementById('shop-btn').style.display='none';
  document.getElementById('reset-btn').style.display='none';
  // Reset battle state
  battleScore=0;
  battleCatches=0;
  opponentScore=0;
  opponentCatches=0;
  opponentStatus='å¾…æ©Ÿä¸­';
  opponentFightInfo=null;opponentFightProgress=0;opponentFightActive=false;
  myActivityStatus='å¾…æ©Ÿä¸­';myFightInfo=null;myFightProgress=0;
  battleTimeLeft=BATTLE_DURATION;
  gameState='idle';
  // Reset ghost fish
  var gf=document.getElementById('opponent-ghost-fish');gf.style.display='none';gf.className='';
  // Show battle HUD
  document.getElementById('battle-hud').style.display='flex';
  updateBattleHUD();
  // Reset cast button
  document.getElementById('cast-btn').style.display='flex';
  // Host starts timer
  if(isHost)startBattleTimer();
}

// ===== PEERJS NETWORKING =====
function cleanupPeer(){
  if(conn){try{conn.close()}catch(e){} conn=null}
  if(peer){try{peer.destroy()}catch(e){} peer=null}
}

function setConnectionStatus(text){
  document.getElementById('connection-status').textContent=text;
}

function createRoom(){
  var roomName=document.getElementById('room-input').value.trim();
  if(!roomName){setConnectionStatus('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  cleanupPeer();
  isHost=true;
  setConnectionStatus('ãƒ«ãƒ¼ãƒ ä½œæˆä¸­...');
  document.getElementById('create-room-btn').disabled=true;
  document.getElementById('join-room-btn').disabled=true;
  var peerId=ROOM_PREFIX+roomName;
  peer=new Peer(peerId,{debug:0});
  peer.on('open',function(){
    setConnectionStatus('ãƒ«ãƒ¼ãƒ ã€Œ'+roomName+'ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    document.getElementById('invite-btn').style.display='inline-block';
    peer.on('connection',function(c){
      conn=c;
      setupConnection();
    });
  });
  peer.on('error',function(err){
    document.getElementById('create-room-btn').disabled=false;
    document.getElementById('join-room-btn').disabled=false;
    if(err.type==='unavailable-id'){
      setConnectionStatus('ã“ã®ãƒ«ãƒ¼ãƒ åã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
    }else{
      setConnectionStatus('ã‚¨ãƒ©ãƒ¼: '+err.message);
    }
  });
}

function joinRoom(){
  var roomName=document.getElementById('room-input').value.trim();
  if(!roomName){setConnectionStatus('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  cleanupPeer();
  isHost=false;
  setConnectionStatus('ãƒ«ãƒ¼ãƒ ã«æ¥ç¶šä¸­...');
  document.getElementById('create-room-btn').disabled=true;
  document.getElementById('join-room-btn').disabled=true;
  peer=new Peer(undefined,{debug:0});
  peer.on('open',function(){
    var hostId=ROOM_PREFIX+roomName;
    conn=peer.connect(hostId,{reliable:true});
    conn.on('open',function(){
      setupConnection();
    });
    conn.on('error',function(err){
      setConnectionStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼: '+err.message);
      document.getElementById('create-room-btn').disabled=false;
      document.getElementById('join-room-btn').disabled=false;
    });
  });
  peer.on('error',function(err){
    document.getElementById('create-room-btn').disabled=false;
    document.getElementById('join-room-btn').disabled=false;
    if(err.type==='peer-unavailable'){
      setConnectionStatus('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }else{
      setConnectionStatus('ã‚¨ãƒ©ãƒ¼: '+err.message);
    }
  });
}

function setupConnection(){
  setConnectionStatus('æ¥ç¶šã—ã¾ã—ãŸï¼ å¯¾æˆ¦ã‚’é–‹å§‹ã—ã¾ã™...');
  conn.on('data',handlePeerMessage);
  conn.on('close',function(){
    if(isBattle){
      endBattle(true);
    }
  });
  if(isHost){
    conn.send({type:'assign',playerNumber:2});
    setTimeout(function(){
      conn.send({type:'start',timeLeft:BATTLE_DURATION});
      startBattle();
    },1500);
  }
}

function handlePeerMessage(msg){
  switch(msg.type){
    case 'assign':
      // Guest receives player number
      break;
    case 'start':
      battleTimeLeft=msg.timeLeft||BATTLE_DURATION;
      document.getElementById('result-screen').style.display='none';
      startBattle();
      break;
    case 'catch':
      opponentScore=msg.totalScore;
      opponentCatches=msg.totalCatches;
      opponentFightActive=false;opponentFightInfo=null;opponentFightProgress=0;
      opponentStatus='é‡£ã‚Šä¸Šã’ãŸ!';
      updateBattleHUD();
      hideGhostFish('catch');
      showOpponentToast(msg.species+' '+msg.size+'cm (+'+msg.reward+'G)');
      break;
    case 'status':
      opponentStatus=msg.statusText;
      if(msg.statusText==='å¾…æ©Ÿä¸­'){opponentFightActive=false;opponentFightInfo=null;opponentFightProgress=0}
      updateBattleHUD();
      break;
    case 'fight-start':
      opponentFightActive=true;
      opponentFightInfo={emoji:msg.emoji,name:msg.name,tier:msg.tier,size:msg.size};
      opponentFightProgress=0;
      opponentStatus='æ ¼é—˜ä¸­';
      updateBattleHUD();
      showGhostFish(msg.emoji);
      break;
    case 'fight-update':
      opponentFightProgress=msg.progress;
      if(opponentFightActive)updateGhostFishPosition(msg.progress);
      updateBattleHUD();
      break;
    case 'escape':
      opponentFightActive=false;opponentFightInfo=null;opponentFightProgress=0;
      opponentStatus='é€ƒã’ã‚‰ã‚ŒãŸ...';
      updateBattleHUD();
      hideGhostFish('escape');
      break;
    case 'timer':
      battleTimeLeft=msg.timeLeft;
      updateBattleHUD();
      break;
    case 'end':
      if(msg.finalScore!==undefined){
        opponentScore=msg.finalScore;
        opponentCatches=msg.finalCatches;
      }
      endBattle(false);
      break;
    case 'rematch':
      // Only host handles rematch requests
      if(isHost){
        conn.send({type:'start',timeLeft:BATTLE_DURATION});
        startBattle();
      }
      break;
  }
}

// ===== BATTLE HUD & TIMER =====
function updateBattleHUD(){
  var hud=document.getElementById('battle-hud');
  if(!hud||hud.style.display==='none')return;
  var timerEl=document.getElementById('battle-timer');
  timerEl.textContent=battleTimeLeft;
  if(battleTimeLeft<=10)timerEl.classList.add('timer-low');
  else timerEl.classList.remove('timer-low');
  updateBattleCard('battle-card-me',battleScore,battleCatches,myActivityStatus,myFightInfo,myFightProgress);
  updateBattleCard('battle-card-op',opponentScore,opponentCatches,opponentFightActive?'æ ¼é—˜ä¸­':opponentStatus,opponentFightActive?opponentFightInfo:null,opponentFightProgress);
}
function updateBattleCard(cardId,score,catches,activity,fightInfo,progress){
  var card=document.getElementById(cardId);if(!card)return;
  card.querySelector('.bc-gold').textContent=score.toLocaleString();
  card.querySelector('.bc-catches').textContent=catches;
  card.querySelector('.battle-card-activity').textContent=activity;
  var fi=card.querySelector('.battle-card-fish-info'),pr=card.querySelector('.battle-card-progress');
  if(fightInfo&&activity==='æ ¼é—˜ä¸­'){
    fi.style.display='block';
    fi.querySelector('.bc-fish-emoji').textContent=fightInfo.emoji;
    fi.querySelector('.bc-fish-name').textContent=fightInfo.name;
    fi.querySelector('.bc-fish-size').textContent=fightInfo.size;
    pr.style.display='flex';
    var pct=Math.round(progress*100);
    pr.querySelector('.bc-progress-pct').textContent=pct+'%';
    var fill=pr.querySelector('.bc-progress-fill');
    fill.style.width=pct+'%';
    if(pct>70)fill.style.background='var(--success)';
    else if(pct>40)fill.style.background='var(--gold)';
    else fill.style.background='var(--danger)';
  }else{fi.style.display='none';pr.style.display='none'}
}
function showGhostFish(emoji){
  var gf=document.getElementById('opponent-ghost-fish');
  gf.textContent=emoji;gf.style.display='block';gf.className='';gf.style.opacity='.3';
  updateGhostFishPosition(0);
}
function updateGhostFishPosition(progress){
  var gf=document.getElementById('opponent-ghost-fish');
  if(gf.style.display==='none')return;
  var waterTop=window.innerHeight*0.30;
  var x=window.innerWidth*0.82-progress*window.innerWidth*0.22;
  var y=waterTop+50+(1-progress)*window.innerHeight*0.12;
  gf.style.left=x+'px';gf.style.top=y+'px';
}
function hideGhostFish(reason){
  var gf=document.getElementById('opponent-ghost-fish');
  if(gf.style.display==='none')return;
  gf.className=reason==='catch'?'ghost-catch':'ghost-escape';
  setTimeout(function(){gf.style.display='none';gf.className=''},700);
}

function startBattleTimer(){
  clearInterval(battleTimer);
  var syncCounter=0;
  battleTimer=setInterval(function(){
    battleTimeLeft--;
    syncCounter++;
    updateBattleHUD();
    // Sync to guest every 5 seconds or every second when <= 10
    if(conn&&conn.open&&(syncCounter%5===0||battleTimeLeft<=10)){
      conn.send({type:'timer',timeLeft:battleTimeLeft});
    }
    if(battleTimeLeft<=0){
      clearInterval(battleTimer);
      // Send end to guest with final scores
      if(conn&&conn.open){
        conn.send({type:'end',finalScore:battleScore,finalCatches:battleCatches});
      }
      endBattle(false);
    }
  },1000);
}

// ===== END BATTLE & RESULT =====
function endBattle(disconnected){
  clearInterval(battleTimer);
  clearInterval(fightInterval);
  if(approachAnim)cancelAnimationFrame(approachAnim);

  // Cancel any ongoing fishing
  gameState='idle';
  lineMode='none';
  myActivityStatus='å¾…æ©Ÿä¸­';myFightInfo=null;myFightProgress=0;
  opponentFightInfo=null;opponentFightProgress=0;opponentFightActive=false;
  var gf=document.getElementById('opponent-ghost-fish');gf.style.display='none';gf.className='';
  ['fight-ui','fishing-line','approaching-fish','bite-scene','waiting-text','fighting-fish','catch-anim-fish'].forEach(function(id){
    var e=document.getElementById(id);
    e.style.display='none';
    if(id==='fishing-line')e.style.animation='none';
  });
  document.getElementById('hit-banner').classList.remove('show');
  document.getElementById('catch-popup').classList.remove('show');
  document.getElementById('escaped-popup').classList.remove('show');
  document.getElementById('cast-btn').style.display='flex';

  // Hide battle HUD
  document.getElementById('battle-hud').style.display='none';

  // Determine result
  var result;
  if(disconnected)result='disconnect';
  else if(battleScore>opponentScore)result='win';
  else if(battleScore<opponentScore)result='lose';
  else result='draw';

  showResult(result);
}

function showResult(result){
  var titles={win:'ğŸ‰ å‹åˆ©ï¼',lose:'ğŸ˜¢ æ•—åŒ—...',draw:'ğŸ¤ å¼•ãåˆ†ã‘',disconnect:'âš¡ åˆ‡æ–­'};
  var titleEl=document.getElementById('result-title');
  titleEl.textContent=titles[result]||'';
  titleEl.className='result-title-'+result;
  document.getElementById('result-my-gold').textContent=battleScore.toLocaleString()+'G';
  document.getElementById('result-my-catches').textContent=battleCatches+'åŒ¹';
  document.getElementById('result-op-gold').textContent=opponentScore.toLocaleString()+'G';
  document.getElementById('result-op-catches').textContent=opponentCatches+'åŒ¹';
  // Reset rematch button state
  var rematchBtn=document.getElementById('rematch-btn');
  rematchBtn.textContent='ğŸ”„ ã‚‚ã†ä¸€åº¦';
  rematchBtn.disabled=false;
  // Hide rematch if disconnected
  rematchBtn.style.display=disconnected?'none':'';
  document.getElementById('result-screen').style.display='flex';
  isBattle=false;
}

function requestRematch(){
  if(!conn||!conn.open){
    backToMenu();
    return;
  }
  if(isHost){
    document.getElementById('result-screen').style.display='none';
    conn.send({type:'start',timeLeft:BATTLE_DURATION});
    startBattle();
  }else{
    // Guest sends rematch request, waits for host
    conn.send({type:'rematch'});
    var btn=document.getElementById('rematch-btn');
    btn.textContent='â³ å¾…æ©Ÿä¸­...';
    btn.disabled=true;
  }
}

function backToMenu(){
  document.getElementById('result-screen').style.display='none';
  cleanupPeer();
  showMenuScreen();
}

// ===== OPPONENT TOAST =====
function showOpponentToast(text){
  var toast=document.getElementById('opponent-toast');
  toast.textContent='ğŸ£ ç›¸æ‰‹: '+text;
  toast.style.display='block';
  toast.style.animation='none';
  toast.offsetHeight; // reflow
  toast.style.animation='toastSlide 2s ease-out forwards';
  setTimeout(function(){toast.style.display='none'},2000);
}

// ===== INVITE LINK =====
function copyInviteLink(){
  var roomName=document.getElementById('room-input').value.trim();
  if(!roomName)return;
  var url=window.location.origin+window.location.pathname+'?room='+encodeURIComponent(roomName);
  if(navigator.share){
    navigator.share({title:'å¤§æ¼ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°å¯¾æˆ¦',text:'é‡£ã‚Šãƒãƒˆãƒ«ã—ã‚ˆã†ï¼',url:url}).catch(function(){});
  }else if(navigator.clipboard){
    navigator.clipboard.writeText(url).then(function(){
      setConnectionStatus('æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    }).catch(function(){
      setConnectionStatus('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
  }
}

// ===== INIT =====
loadGame();updateHUD();for(var i=0;i<3;i++)spawnBgFish();showMenuScreen();
</script>
</body>
</html>
